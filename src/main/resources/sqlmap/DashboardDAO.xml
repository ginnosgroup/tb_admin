<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.zhinanzhen.b.dao.DashboardDAO">
    
    <cache eviction="LRU" flushInterval="120000" readOnly="false" size="100"></cache>

    <select id="getThisMonthVisaExpectAmount" resultType="java.lang.Double">
        select IFNULL(sum(IF(currency='CNY',expect_amount/exchange_rate,expect_amount)),0.00) FROM b_visa bv, tb_adviser tba where DATE_FORMAT(kj_approval_date, '%Y%m') = DATE_FORMAT(CURDATE(), '%Y%m')
        and is_close = 0 and bv.state != 'PENDING' and bv.state != 'WAIT' AND tba.id = bv.adviser_id
        <if test='adviserId != null'>
            AND bv.adviser_id = #{adviserId}
        </if>
        <if test='regionIdList != null'>
            AND tba.region_id IN
            <foreach collection="regionIdList" item="regionIdList" index="index" open="(" close=")" separator=",">
                #{regionIdList}
            </foreach>
        </if>
        ;
    </select>
    <select id="getThisMonthbCommissionOrderExpectAmountSBBTM" resultType="java.lang.Double">
        select IFNULL(sum(IF(currency='CNY',expect_amount/exchange_rate,expect_amount)),0.00) FROM b_commission_order bco , tb_adviser tba  where DATE_FORMAT(kj_approval_date, '%Y%m') = DATE_FORMAT(CURDATE(), '%Y%m')
        and is_close = 0 and bco.state != 'PENDING' and bco.state != 'WAIT' AND tba.id = bco.adviser_id
        <if test='adviserId != null'>
            AND bco.adviser_id = #{adviserId}
        </if>
        <if test='regionIdList != null'>
            AND tba.region_id IN
            <foreach collection="regionIdList" item="regionIdList" index="index" open="(" close=")" separator=",">
                #{regionIdList}
            </foreach>
        </if>
        ;
    </select>
    
    <select id="getThisMonthRefundAmount" resultType="java.lang.Double">
        select IFNULL(sum(IF(r.currency_type='CNY',r.amount/(SELECT znz_exchange_rate FROM b_everyday_exchange_rate ORDER BY gmt_create DESC LIMIT 1),r.amount)),0.00) FROM b_refund r, tb_adviser tba  where DATE_FORMAT(r.completed_date, '%Y%m') = DATE_FORMAT(CURDATE(), '%Y%m')
        AND r.state = 'PAID' AND tba.id = r.adviser_id
        <if test='adviserId != null'>
            AND r.adviser_id = #{adviserId}
        </if>
        <if test='regionIdList != null'>
            AND tba.region_id IN
            <foreach collection="regionIdList" item="regionIdList" index="index" open="(" close=")" separator=",">
                #{regionIdList}
            </foreach>
        </if>
        ;
    </select>
    
    <select id="getVisaUnassignedBonusAmount" resultType="java.lang.Double">
        SELECT IFNULL(sum(IF(currency='CNY',bonus/exchange_rate,bonus)),0.00) FROM b_visa WHERE state!='CLOSE' AND bonus_date IS NULL;
    </select>
    <select id="getCommissionOrderUnassignedBonusAmount" resultType="java.lang.Double">
        SELECT IFNULL(sum(IF(currency='CNY',bonus/exchange_rate,bonus)),0.00) FROM b_commission_order WHERE state!='CLOSE' AND bonus_date IS NULL;
    </select>
    <select id="getCommissionOrderDZYUnassignedBonusAmount" resultType="java.lang.Double">
        SELECT IFNULL(sum(IF(currency='CNY',bonus/exchange_rate,bonus)),0.00) FROM b_commission_order WHERE state!='CLOSE' AND commission_state='DZY' AND bonus_date IS NULL;
    </select>
    <select id="getCommissionOrderSettleUnassignedBonusAmount" resultType="java.lang.Double">
        SELECT IFNULL(sum(IF(co.currency='CNY',co.bonus/co.exchange_rate,co.bonus)),0.00) FROM b_commission_order co, b_service_order so WHERE co.service_order_id=so.id AND co.state!='CLOSE' AND so.is_settle=1 AND co.bonus_date IS NULL;
    </select>
    <select id="summaryVisaUnassignedBonusAmount" resultType="org.zhinanzhen.b.dao.pojo.DashboardAmountSummaryDO">
        SELECT r.id, r.name AS name1, count(v.id) AS total, IFNULL(sum(IF(v.currency='CNY',v.bonus*v.exchange_rate,v.bonus)),0.00) AS amount
        FROM b_visa v, tb_user u, tb_region r
        WHERE v.user_id=u.id AND u.region_id=r.id AND u.region_id>0 AND v.state!='CLOSE' AND v.bonus_date IS NULL GROUP BY r.id ORDER BY IFNULL(sum(v.bonus),0.00) DESC;
    </select>
    <select id="summaryCommissionOrderUnassignedBonusAmount" resultType="org.zhinanzhen.b.dao.pojo.DashboardAmountSummaryDO">
        SELECT r.id, r.name AS name1, count(co.id) AS total, IFNULL(sum(IF(co.currency='CNY',co.bonus/co.exchange_rate,co.bonus)),0.00) AS amount
        FROM b_commission_order co, tb_user u, tb_region r
        WHERE co.user_id=u.id AND u.region_id=r.id AND u.region_id>0 AND co.state!='CLOSE' AND co.bonus_date IS NULL GROUP BY r.id ORDER BY IFNULL(sum(co.bonus),0.00) DESC;
    </select>
    <select id="summaryCommissionOrderDZYUnassignedBonusAmount" resultType="org.zhinanzhen.b.dao.pojo.DashboardAmountSummaryDO">
        SELECT r.id, r.name AS name1, count(co.id) AS total, IFNULL(sum(IF(co.currency='CNY',co.bonus/co.exchange_rate,co.bonus)),0.00) AS amount
        FROM b_commission_order co, tb_user u, tb_region r
        WHERE co.user_id=u.id AND u.region_id=r.id AND u.region_id>0 AND co.state!='CLOSE' AND co.commission_state='DZY' AND co.bonus_date IS NULL GROUP BY r.id ORDER BY IFNULL(sum(co.bonus),0.00) DESC;
    </select>
    <select id="summaryCommissionOrderSettleUnassignedBonusAmount" resultType="org.zhinanzhen.b.dao.pojo.DashboardAmountSummaryDO">
        SELECT r.id, r.name AS name1, count(co.id) AS total, IFNULL(sum(IF(co.currency='CNY',co.bonus/co.exchange_rate,co.bonus)),0.00) AS amount
        FROM b_commission_order co, tb_user u, tb_region r, b_service_order so
        WHERE co.service_order_id=so.id AND co.user_id=u.id AND u.region_id=r.id AND u.region_id>0 AND co.state!='CLOSE' AND so.is_settle=1 AND co.bonus_date IS NULL GROUP BY r.id ORDER BY IFNULL(sum(co.bonus),0.00) DESC;
    </select>
    <select id="summaryCommissionOrderDZYUnassignedBonusAmountGroupBySchool" resultType="org.zhinanzhen.b.dao.pojo.DashboardAmountSummaryDO">
        SELECT si.id, si.institution_trading_name AS name1, si.institution_name AS name2, count(co.id) AS total, IFNULL(sum(IF(co.currency='CNY',co.bonus/co.exchange_rate,co.bonus)),0.00) AS amount
        FROM b_commission_order co, b_school_course sc, b_school_institution si
        WHERE co.course_id=sc.id AND sc.provider_id=si.id AND co.state!='CLOSE' AND co.commission_state='DZY' AND co.bonus_date IS NULL GROUP BY si.id ORDER BY IFNULL(sum(co.bonus),0.00) DESC;
    </select>
    <select id="summaryCommissionOrderSettleUnassignedBonusAmountGroupBySchool" resultType="org.zhinanzhen.b.dao.pojo.DashboardAmountSummaryDO">
        SELECT si.id, si.institution_trading_name AS name1, si.institution_name AS name2, count(co.id) AS total, IFNULL(sum(IF(co.currency='CNY',co.bonus/co.exchange_rate,co.bonus)),0.00) AS amount
        FROM b_commission_order co, b_school_course sc, b_school_institution si, b_service_order so
        WHERE co.service_order_id=so.id AND co.course_id=sc.id AND sc.provider_id=si.id AND co.state!='CLOSE' AND so.is_settle=1 AND co.bonus_date IS NULL GROUP BY si.id ORDER BY IFNULL(sum(co.bonus),0.00) DESC;
    </select>
    
</mapper>
