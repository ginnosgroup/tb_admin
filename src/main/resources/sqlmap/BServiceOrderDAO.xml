<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.zhinanzhen.b.dao.ServiceOrderDAO">

    <insert id="addServiceOrder" parameterType="org.zhinanzhen.b.dao.pojo.ServiceOrderDO" useGeneratedKeys="true"
            keyProperty="id">
        INSERT
            INTO b_service_order (
                gmt_create,
                gmt_modify,
                code,
                finish_date,
                type,
                people_number,
                people_type,
                people_remarks,
                service_id,
                parent_id,
                applicant_parent_id,
                service_package_id,
                school_id,
                course_id,
                school_institution_location_id,
                institution_trading_name,
                state,
                state_mark,
                state_mark2,
                urgent_state,
                mara_approval_date,
                official_approval_date,
                is_settle,
                is_deposit_user,
                is_submitted,
                subagency_id,
                is_pay,
                receive_type_id,
                receive_date,
                receivable,
                discount,
                received,
                installment,
                payment_voucher_image_url_1,
                payment_voucher_image_url_2,
                payment_voucher_image_url_3,
                payment_voucher_image_url_4,
                payment_voucher_image_url_5,
                coe_payment_voucher_image_url_1,
                coe_payment_voucher_image_url_2,
                coe_payment_voucher_image_url_3,
                coe_payment_voucher_image_url_4,
                coe_payment_voucher_image_url_5,
                visa_voucher_image_url,
                low_price_image_url,
                per_amount,
                amount,
                expect_amount,
                currency,
                exchange_rate,
                gst,
                deduct_gst,
                bonus,
                user_id,
                applicant_id,
                mara_id,
                adviser_id,
                adviser_id_2,
                official_id,
                remarks,
                refuse_reason,
                closed_reason,
                is_delete,
                information,
                is_history,
                nut_cloud,
                service_assess_id,
                real_people_number,
                verify_code,
                ref_no,
                EOI_number,
                binding_order,
                offer_type,
                offer_url,
                expect_time_enrollment,
                is_apply_visa,
                visa_number)
            VALUES (
                now(),
                now(),
                #{code},
                NULL,
                #{type},
                #{peopleNumber},
                #{peopleType},
                #{peopleRemarks},
                #{serviceId},
                #{parentId},
                #{applicantParentId},
                #{servicePackageId},
                #{schoolId},
                #{courseId},
                #{schoolInstitutionLocationId},
                #{institutionTradingName},
                #{state},
                #{stateMark},
                #{stateMark2},
                #{urgentState},
                NULL,
                NULL,
                #{isSettle},
                #{isDepositUser},
                #{isSubmitted},
                #{subagencyId},
                #{isPay},
                #{receiveTypeId},
                #{receiveDate},
                #{receivable},
                #{discount},
                #{received},
                #{installment},
                #{paymentVoucherImageUrl1},
                #{paymentVoucherImageUrl2},
                #{paymentVoucherImageUrl3},
                #{paymentVoucherImageUrl4},
                #{paymentVoucherImageUrl5},
                #{coePaymentVoucherImageUrl1},
                #{coePaymentVoucherImageUrl2},
                #{coePaymentVoucherImageUrl3},
                #{coePaymentVoucherImageUrl4},
                #{coePaymentVoucherImageUrl5},
                #{visaVoucherImageUrl},
                #{lowPriceImageUrl},
                #{perAmount},
                #{amount},
                #{expectAmount},
                #{currency},
                #{exchangeRate},
                #{gst},
                #{deductGst},
                #{bonus},
                #{userId},
                #{applicantId},
                #{maraId},
                #{adviserId},
                #{adviserId2},
                #{officialId},
                #{remarks},
                #{refuseReason},
                #{closedReason},
                0,
                #{information},
                #{isHistory},
                #{nutCloud},
                #{serviceAssessId},
                #{realPeopleNumber},
                #{verifyCode},
                #{refNo},
                #{EOINumber},
                #{bindingOrder},
                #{offerType},
                #{offerUrl},
                #{expectTimeEnrollment},
                #{isApplyVisa},
                #{visaNumber});
    </insert>

    <update id="updateServiceOrder" parameterType="org.zhinanzhen.b.dao.pojo.ServiceOrderDO">
        UPDATE b_service_order
        SET gmt_modify = now()
        <if test='type != null and type != ""'>
            , type = #{type}
        </if>
        <if test='peopleNumber != null and peopleNumber != ""'>
            , people_number = #{peopleNumber}
        </if>
        <if test='peopleType != null and peopleType != ""'>
            , people_type = #{peopleType}
        </if>
        <if test='peopleRemarks != null and peopleRemarks != ""'>
            , people_remarks = #{peopleRemarks}
        </if>
        <if test='serviceId != null and serviceId > 0'>
            , service_id = #{serviceId}
        </if>
        <if test='parentId != null and parentId > 0'>
            , parent_id = #{parentId}
        </if>
        <if test='applicantParentId != null and applicantParentId > 0'>
            , applicant_parent_id = #{applicantParentId}
        </if>
        <if test='servicePackageId != null and servicePackageId > 0'>
            , service_package_id = #{servicePackageId}
        </if>
        <if test='schoolId != null and schoolId > 0'>
            , school_id = #{schoolId}
        </if>
        <if test="courseId != null and courseId > 0">
            , course_id = #{courseId}
        </if>
        <if test="schoolInstitutionLocationId != null and schoolInstitutionLocationId > 0">
            , school_institution_location_id = #{schoolInstitutionLocationId}
        </if>
        <if test='institutionTradingName != null and institutionTradingName != ""'>
            , institution_trading_name = #{institutionTradingName}
        </if>
        <if test='state != null and state != ""'>
            , state = #{state}
        </if>
        <if test='stateMark != null'>
            , state_mark = #{stateMark}
        </if>
        <if test='stateMark2 != null'>
            , state_mark2 = #{stateMark2}
        </if>
        <if test='urgentState != null and urgentState != ""'>
            , urgent_state = #{urgentState}
        </if>
        <if test='urgentState == ""'>
            , urgent_state = NULL
        </if>
        <if test='maraApprovalDate != null'>
            , mara_approval_date = #{maraApprovalDate}
        </if>
        <if test='submitMaraApprovalDate != null'>
            , submit_mara_approval_date = #{submitMaraApprovalDate}
        </if>
        <if test='officialApprovalDate != null'>
            , official_approval_date = #{officialApprovalDate}
        </if>
        <if test='isSettle != null'>
            , is_settle = #{isSettle}
        </if>
        <if test='isDepositUser != null'>
            , is_deposit_user = #{isDepositUser}
        </if>
        <if test='isSubmitted != null'>
            , is_submitted = #{isSubmitted}
        </if>
        <if test='subagencyId != null and subagencyId > 0'>
            , subagency_id = #{subagencyId}
        </if>
        <if test='isPay != null'>
            , is_pay = #{isPay}
        </if>
        <if test='receiveTypeId != null and receiveTypeId > 0'>
            , receive_type_id = #{receiveTypeId}
        </if>
        <if test='receiveDate != null'>
            , receive_date = #{receiveDate}
        </if>
        <if test='receivable != null and receivable != ""'>
            , receivable = #{receivable}
        </if>
        <if test='discount != null and discount != ""'>
            , discount = #{discount}
        </if>
        <if test='received != null and received != ""'>
            , received = #{received}
        </if>
        <if test='installment != null and installment > 0'>
            , installment = #{installment}
        </if>
        <if test='paymentVoucherImageUrl1 != null'>
            , payment_voucher_image_url_1 = #{paymentVoucherImageUrl1}
        </if>
        <if test='paymentVoucherImageUrl2 != null'>
            , payment_voucher_image_url_2 = #{paymentVoucherImageUrl2}
        </if>
        <if test='paymentVoucherImageUrl3 != null'>
            , payment_voucher_image_url_3 = #{paymentVoucherImageUrl3}
        </if>
        <if test='paymentVoucherImageUrl4 != null'>
            , payment_voucher_image_url_4 = #{paymentVoucherImageUrl4}
        </if>
        <if test='paymentVoucherImageUrl5 != null'>
            , payment_voucher_image_url_5 = #{paymentVoucherImageUrl5}
        </if>
        <if test='coePaymentVoucherImageUrl1 != null'>
            , coe_payment_voucher_image_url_1 = #{coePaymentVoucherImageUrl1}
        </if>
        <if test='coePaymentVoucherImageUrl2 != null'>
            , coe_payment_voucher_image_url_2 = #{coePaymentVoucherImageUrl2}
        </if>
        <if test='coePaymentVoucherImageUrl3 != null'>
            , coe_payment_voucher_image_url_3 = #{coePaymentVoucherImageUrl3}
        </if>
        <if test='coePaymentVoucherImageUrl4 != null'>
            , coe_payment_voucher_image_url_4 = #{coePaymentVoucherImageUrl4}
        </if>
        <if test='coePaymentVoucherImageUrl5 != null'>
            , coe_payment_voucher_image_url_5 = #{coePaymentVoucherImageUrl5}
        </if>
        <if test='visaVoucherImageUrl != null'>
            , visa_voucher_image_url = #{visaVoucherImageUrl}
        </if>
        <if test='invoiceVoucherImageUrl1 != null'>
            , invoice_voucher_image_url1 = #{invoiceVoucherImageUrl1}
        </if>
        <if test='invoiceVoucherImageUrl2 != null'>
            , invoice_voucher_image_url2 = #{invoiceVoucherImageUrl2}
        </if>
        <if test='invoiceVoucherImageUrl3 != null'>
            , invoice_voucher_image_url3 = #{invoiceVoucherImageUrl3}
        </if>
        <if test='invoiceVoucherImageUrl4 != null'>
            , invoice_voucher_image_url4 = #{invoiceVoucherImageUrl4}
        </if>
        <if test='invoiceVoucherImageUrl5 != null'>
            , invoice_voucher_image_url5 = #{invoiceVoucherImageUrl5}
        </if>
        <if test='kjPaymentImageUrl1 != null'>
            , kj_payment_image_url1 = #{kjPaymentImageUrl1}
        </if>
        <if test='kjPaymentImageUrl2 != null'>
            , kj_payment_image_url2 = #{kjPaymentImageUrl2}
        </if>
        <if test='lowPriceImageUrl != null'>
            , low_price_image_url = #{lowPriceImageUrl}
        </if>
        <if test='perAmount > 0'>
            , per_amount = #{perAmount}
        </if>
        <if test='amount > 0'>
            , amount = #{amount}
        </if>
        <if test='expectAmount > 0'>
            , expect_amount = #{expectAmount}
        </if>
        <if test='currency != null and currency != ""'>
            , currency = #{currency}
        </if>
        <if test='exchangeRate != null and exchangeRate != ""'>
            , exchange_rate = #{exchangeRate}
        </if>
        <if test='gst != null'>
            , gst = #{gst}
        </if>
        <if test='deductGst != null'>
            , deduct_gst = #{deductGst}
        </if>
        <if test='bonus != null'>
            , bonus = #{bonus}
        </if>
        <if test='userId != null and userId > 0'>
            , user_id = #{userId}
        </if>
        <if test='applicantId != null'>
            , applicant_id = #{applicantId}
        </if>
        <if test='maraId != null and maraId > 0'>
            , mara_id = #{maraId}
        </if>
        <if test='adviserId != null and adviserId > 0'>
            , adviser_id = #{adviserId}
        </if>
        <if test='adviserId2 != null and adviserId2 > 0'>
            , adviser_id_2 = #{adviserId2}
        </if>
        <if test='officialId != null'>
            , official_id = #{officialId}
        </if>
        <if test='remarks != null'>
            , remarks = #{remarks}
        </if>
        <if test='refuseReason != null'>
            , refuse_reason = #{refuseReason}
        </if>
        <if test='closedReason != null'>
            , closed_reason = #{closedReason}
        </if>
        <if test="information != null">
            , information = #{information}
        </if>
        <if test="isHistory != null">
            , is_history = #{isHistory}
        </if>
        <if test="nutCloud != null">
            , nut_cloud = #{nutCloud}
        </if>
        <if test="serviceAssessId != null">
            , service_assess_id = #{serviceAssessId}
        </if>
        <if test=" realPeopleNumber != null  and realPeopleNumber > 0 ">
            , real_People_Number = #{realPeopleNumber}
        </if>
        <if test="verifyCode != null">
            ,verify_code = #{verifyCode}
        </if>
        <if test="readcommittedDate != null">
            ,readcommitted_date = #{readcommittedDate}
        </if>
        <if test="refNo != null">
            ,ref_no = #{refNo}
        </if>
        <if test="EOINumber != null">
            ,EOI_number = #{EOINumber}
        </if>
        <if test="bindingOrder != null">
            ,binding_order = #{bindingOrder}
        </if>
        <if test="offerType != null">
            ,offer_type = #{offerType}
        </if>
        <if test="offerUrl != null">
            ,offer_url = #{offerUrl}
        </if>
        <if test="expectTimeEnrollment != null">
            ,expect_time_enrollment = #{expectTimeEnrollment}
        </if>
        <if test="isApplyVisa != null">
            ,is_apply_visa = #{isApplyVisa}
        </if>
        <if test="visaNumber != null">
            ,visa_number = #{visaNumber}
        </if>
        WHERE id = #{id};
    </update>

    <update id="updateReviewState">
        UPDATE b_service_order 
        SET gmt_modify = now(), review_state = #{reviewState}
        WHERE id = #{id};
    </update>

    <update id="updateService">
        UPDATE b_service_order
        SET gmt_modify = now(), service_id = #{serviceId}
        <if test='serviceAssessId != null and serviceAssessId > 0'>
            , service_assess_id = #{serviceAssessId}
        </if>
        WHERE id = #{id};
    </update>


    <select id="countServiceOrder" resultType="java.lang.Integer">
        SELECT count(*)
        FROM tb_user u, tb_adviser a, b_service_order so LEFT JOIN b_service_order_official_tag soot ON
        so.id=soot.service_order_id LEFT JOIN b_applicant ap ON ap.id = so.applicant_id
        WHERE so.is_delete = 0 AND a.id = so.adviser_id AND u.id = so.user_id
        <if test='type != null and type != "" and type != "VISAZX" and type != "bindingList" and type != "bindingList2"'>
            AND so.type = #{type}
        </if>
        <if test='type == "VISAZX"'>
            AND so.type in("VISA","ZX")
        </if>
        <if test='type != null and type != "" and type == "bindingList"'>
            AND so.type != 'OVST' AND so.applicant_parent_id = 0 AND binding_order IS NULL
        </if>
        <if test='type != null and type != "" and type == "bindingList2"'>
            AND so.applicant_parent_id = 0 AND binding_order IS NULL
        </if>
        <if test='excludeState != null and excludeState != ""'>
            AND so.state != #{excludeState}
        </if>
        <if test='stateList != null'>
            AND so.state IN
            <foreach collection="stateList" item="stateList" index="index" open="(" close=")" separator=",">
                #{stateList}
            </foreach>
        </if>
        <if test='reviewStateList != null'>
            AND so.review_state IN
            <foreach collection="reviewStateList" item="reviewStateList" index="index" open="(" close=")" separator=",">
                #{reviewStateList}
            </foreach>
        </if>
        <if test='urgentState != null and urgentState != ""'>
            AND so.urgent_state != #{urgentState}
        </if>
        <if test='startMaraApprovalDate != null and startMaraApprovalDate != "" and endMaraApprovalDate != null and endMaraApprovalDate != ""'>
            <![CDATA[ AND so.mara_approval_date > #{startMaraApprovalDate} AND so.mara_approval_date < #{endMaraApprovalDate} ]]>
        </if>
        <if test='startOfficialApprovalDate != null and startOfficialApprovalDate != "" and endOfficialApprovalDate != null and endOfficialApprovalDate != ""'>
            <![CDATA[ AND so.official_approval_date > #{startOfficialApprovalDate} AND so.official_approval_date < #{endOfficialApprovalDate} ]]>
        </if>
        <if test='startReadcommittedDate != null and startReadcommittedDate != "" and endReadcommittedDate != null and endReadcommittedDate != ""'>
            <![CDATA[ AND so.readcommitted_date > #{startReadcommittedDate} AND so.readcommitted_date < #{endReadcommittedDate} ]]>
        </if>
        <if test='startFinishDate != null and startFinishDate != "" and endFinishDate != null and endFinishDate != ""'>
            <![CDATA[ AND so.finish_date > #{startFinishDate} AND so.finish_date < #{endFinishDate} ]]>
        </if>
        <if test='regionIdList != null'>
            AND a.region_id IN
            <foreach collection="regionIdList" item="regionIdList" index="index" open="(" close=")" separator=",">
                #{regionIdList}
            </foreach>
        </if>
        <if test='userId != null and userId > 0'>
            AND so.user_id = #{userId}
        </if>
        <if test='maraId != null and maraId > 0'>
            AND so.mara_id = #{maraId}
        </if>
        <if test='adviserId != null and adviserId > 0'>
            AND (so.adviser_id = #{adviserId} OR so.adviser_id_2 = #{adviserId})
        </if>
        <if test='officialId != null and officialId > 0'>
            AND so.official_id = #{officialId}
        </if>
        <if test='officialTagId != null and officialTagId > 0'>
            AND soot.official_tag_id = #{officialTagId}
        </if>
        <if test='parentId != null and parentId > 0'>
            AND so.parent_id = #{parentId}
        </if>
        <if test='applicantParentId != null and applicantParentId > 0'>
            AND so.applicant_parent_id = #{applicantParentId}
        </if>
        <if test='serviceId != null and serviceId > 0'>
            AND so.service_id = #{serviceId}
        </if>
        <if test='schoolId != null and schoolId > 0'>
            AND so.school_id = #{schoolId}
        </if>
        <if test='isNotApproved == true'>
            <![CDATA[ AND (SELECT COUNT(id) FROM b_service_order_review WHERE service_order_id = so.id AND official_state IS NOT NULL) <= 0 ]]>
        </if>
        <if test='auditingState == "MAWAIT"'>
            <![CDATA[ AND (SELECT COUNT(id) FROM b_service_order_review WHERE service_order_id = so.id AND official_state="WAIT" AND mara_state="WAIT") > 0 AND (SELECT COUNT(id) FROM b_service_order_review WHERE service_order_id = so.id AND official_state="REVIEW" AND mara_state="FINISH") <= 0 ]]>
        </if>
        <if test='auditingState == "MAFINISH"'>
            <![CDATA[ AND (SELECT COUNT(id) FROM b_service_order_review WHERE service_order_id = so.id AND official_state="REVIEW" AND mara_state="FINISH") > 0 ]]>
        </if>
        <if test='userName != null and userName != ""'>
            AND u.name LIKE '%${userName}%'
        </if>
        <if test='applicantName != null and applicantName != ""'>
            AND (ap.surname LIKE '%${applicantName}%' OR ap.firstname LIKE '%${applicantName}%' OR CONCAT(ap.firstname,
            ' ', ap.surname) = #{applicantName})
        </if>
        <if test="isPay != null">
            AND so.is_pay = #{isPay}
        </if>
        <if test="isSettle != null">
            AND so.is_settle = #{isSettle}
        </if>
        <if test="servicePackageId">
            AND so.service_package_id = #{servicePackageId}
        </if>
        ;
    </select>

    <select id="listServiceOrder" resultType="org.zhinanzhen.b.dao.pojo.ServiceOrderDO">
        SELECT
        so.id AS id,
        so.gmt_create AS gmtCreate,
        so.gmt_modify AS gmtModify,
        so.code AS code,
        so.finish_date AS finishDate,
        so.type AS type,
        so.people_number AS peopleNumber,
        so.people_type AS peopleType,
        so.people_remarks AS peopleRemarks,
        so.service_id AS serviceId,
        so.parent_id AS parentId,
        so.applicant_parent_id AS applicantParentId,
        so.service_package_id AS servicePackageId,
        so.school_id AS schoolId,
        so.course_id AS courseId,
        so.school_institution_location_id AS schoolInstitutionLocationId,
        so.institution_trading_name AS institutionTradingName,
        so.state AS state,
        so.state_mark AS stateMark,
        so.state_mark2 AS stateMark2,
        so.urgent_state AS urgentState,
        so.mara_approval_date AS maraApprovalDate,
        so.submit_mara_approval_date AS submitMaraApprovalDate,
        so.official_approval_date AS officialApprovalDate,
        so.is_settle AS isSettle,
        so.is_deposit_user AS isDepositUser,
        so.is_submitted AS isSubmitted,
        so.subagency_id AS subagencyId,
        so.is_pay AS isPay,
        so.receive_type_id AS receiveTypeId,
        so.receive_date AS receiveDate,
        so.receivable AS receivable,
        so.discount AS discount,
        so.received AS received,
        so.installment AS installment,
        so.payment_voucher_image_url_1 AS paymentVoucherImageUrl1,
        so.payment_voucher_image_url_2 AS paymentVoucherImageUrl2,
        so.payment_voucher_image_url_3 AS paymentVoucherImageUrl3,
        so.payment_voucher_image_url_4 AS paymentVoucherImageUrl4,
        so.payment_voucher_image_url_5 AS paymentVoucherImageUrl5,
        so.coe_payment_voucher_image_url_1 AS coePaymentVoucherImageUrl1,
        so.coe_payment_voucher_image_url_2 AS coePaymentVoucherImageUrl2,
        so.coe_payment_voucher_image_url_3 AS coePaymentVoucherImageUrl3,
        so.coe_payment_voucher_image_url_4 AS coePaymentVoucherImageUrl4,
        so.coe_payment_voucher_image_url_5 AS coePaymentVoucherImageUrl5,
        so.visa_voucher_image_url AS visaVoucherImageUrl,
        so.invoice_voucher_image_url1 AS invoiceVoucherImageUrl1,
        so.invoice_voucher_image_url2 AS invoiceVoucherImageUrl2,
        so.invoice_voucher_image_url3 AS invoiceVoucherImageUrl3,
        so.invoice_voucher_image_url4 AS invoiceVoucherImageUrl4,
        so.invoice_voucher_image_url5 AS invoiceVoucherImageUrl5,
        so.kj_payment_image_url1 AS kjPaymentImageUrl1,
        so.kj_payment_image_url2 AS kjPaymentImageUrl2,
        so.low_price_image_url AS lowPriceImageUrl,
        so.per_amount AS perAmount,
        so.amount AS amount,
        so.expect_amount AS expectAmount,
        so.currency,
        so.exchange_rate AS exchangeRate,
        so.gst AS gst,
        so.deduct_gst AS deductGst,
        so.bonus AS bonus,
        so.user_id AS userId,
        so.applicant_id AS applicantId,
        so.mara_id AS maraId,
        so.adviser_id AS adviserId,
        so.adviser_id_2 AS adviserId2,
        so.official_id AS officialId,
        so.remarks AS remarks,
        so.refuse_reason AS refuseReason,
        so.closed_reason AS closedReason,
        so.information AS information ,
        so.is_history AS isHistory,
        so.nut_cloud AS nutCloud,
        so.service_assess_id AS serviceAssessId ,
        so.real_people_number AS realPeopleNumber ,
        so.verify_code AS verifyCode ,
        so.readcommitted_date AS readcommittedDate,
        so.ref_no AS refNo,
        so.EOI_number AS EOINumber,
        so.binding_order AS bindingOrder,
        so.offer_type AS offerType,
        so.offer_url AS offerUrl,
        so.expect_time_enrollment AS expectTimeEnrollment,
        so.is_apply_visa AS isApplyVisa,
        so.visa_number AS visaNumber
        FROM tb_user u, tb_adviser a, b_service_order so LEFT JOIN b_service_order_official_tag soot ON
        so.id=soot.service_order_id LEFT JOIN b_applicant ap ON ap.id = so.applicant_id
        WHERE so.is_delete = 0 AND a.id = so.adviser_id AND u.id = so.user_id
        <if test='startGmtCreate != null and startGmtCreate != "" and endGmtCreate != null and endGmtCreate != ""'>
            <![CDATA[ AND so.gmt_create > #{startGmtCreate} AND so.gmt_create < #{endGmtCreate} ]]>
        </if>
        <if test='type != null and type != "" and type != "VISAZX" and type != "SIV" and type != "NSV" and type != "bindingList" and type != "bindingList2"'>
            AND so.type = #{type}
        </if>
        <if test='type != null and type != "" and type == "bindingList"'>
            AND so.type != 'OVST' AND (so.applicant_parent_id = 0 OR ISNULL(so.applicant_parent_id) ) AND binding_order IS NULL
        </if>
        <if test='type != null and type != "" and type == "bindingList2"'>
            AND so.applicant_parent_id = 0 AND binding_order IS NULL
        </if>
        <if test='type == "VISAZX"'>
            AND so.type in ("VISA","ZX")
        </if>
        <if test='type == "SIV"'>
            AND so.`code` in (SELECT `code` FROM b_service_order WHERE type="SIV")
        </if>
        <if test='type == "NSV"'>
            AND so.`code` in (SELECT `code` FROM b_service_order WHERE type="NSV")
        </if>
        <if test='excludeState != null and excludeState != ""'>
            AND so.state != #{excludeState}
        </if>
        <if test='stateList != null'>
            AND so.state IN
            <foreach collection="stateList" item="stateList" index="index" open="(" close=")" separator=",">
                #{stateList}
            </foreach>
        </if>
        <if test='reviewStateList != null'>
            AND so.review_state IN
            <foreach collection="reviewStateList" item="reviewStateList" index="index" open="(" close=")" separator=",">
                #{reviewStateList}
            </foreach>
        </if>
        <if test='urgentState != null and urgentState != ""'>
            AND so.urgent_state != #{urgentState}
        </if>
        <if test='startMaraApprovalDate != null and startMaraApprovalDate != "" and endMaraApprovalDate != null and endMaraApprovalDate != ""'>
            <![CDATA[ AND so.mara_approval_date > #{startMaraApprovalDate} AND so.mara_approval_date < #{endMaraApprovalDate} ]]>
        </if>
        <if test='startOfficialApprovalDate != null and startOfficialApprovalDate != "" and endOfficialApprovalDate != null and endOfficialApprovalDate != ""'>
            <![CDATA[ AND so.official_approval_date > #{startOfficialApprovalDate} AND so.official_approval_date < #{endOfficialApprovalDate} ]]>
        </if>
        <if test='startReadcommittedDate != null and startReadcommittedDate != "" and endReadcommittedDate != null and endReadcommittedDate != ""'>
            <![CDATA[ AND so.readcommitted_date > #{startReadcommittedDate} AND so.readcommitted_date < #{endReadcommittedDate} ]]>
        </if>
        <if test='startFinishDate != null and startFinishDate != "" and endFinishDate != null and endFinishDate != ""'>
            <![CDATA[ AND so.finish_date > #{startFinishDate} AND so.finish_date < #{endFinishDate} ]]>
        </if>
        <if test='regionIdList != null'>
            AND a.region_id IN
            <foreach collection="regionIdList" item="regionIdList" index="index" open="(" close=")" separator=",">
                #{regionIdList}
            </foreach>
        </if>
        <if test='userId != null and userId > 0'>
            AND so.user_id = #{userId}
        </if>
        <if test='maraId != null and maraId > 0'>
            AND so.mara_id = #{maraId}
        </if>
        <if test='adviserId != null and adviserId > 0'>
            AND (so.adviser_id = #{adviserId} OR so.adviser_id_2 = #{adviserId})
        </if>
        <if test='officialId != null and officialId > 0'>
            AND so.official_id = #{officialId}
        </if>
        <if test='officialTagId != null and officialTagId > 0'>
            AND soot.official_tag_id = #{officialTagId}
        </if>
        <if test='parentId != null and parentId > 0'>
            AND so.parent_id = #{parentId}
        </if>
        <if test='applicantParentId != null and applicantParentId > 0'>
            AND so.applicant_parent_id = #{applicantParentId}
        </if>
        <if test='isNotApproved == true'>
            <![CDATA[ AND (SELECT COUNT(id) FROM b_service_order_review WHERE service_order_id = so.id AND official_state IS NOT NULL) <= 0 ]]>
        </if>
        <if test='auditingState == "MAWAIT"'>
            <![CDATA[ AND (SELECT COUNT(id) FROM b_service_order_review WHERE service_order_id = so.id AND official_state="WAIT" AND mara_state="WAIT") > 0 AND (SELECT COUNT(id) FROM b_service_order_review WHERE service_order_id = so.id AND official_state="REVIEW" AND mara_state="FINISH") <= 0 ]]>
        </if>
        <if test='auditingState == "MAFINISH"'>
            <![CDATA[ AND (SELECT COUNT(id) FROM b_service_order_review WHERE service_order_id = so.id AND official_state="REVIEW" AND mara_state="FINISH") > 0 ]]>
        </if>
        <if test="schoolId != null and  schoolId > 0">
            AND so.school_id = #{schoolId}
        </if>
        <if test="serviceId != null and  serviceId > 0">
            AND so.service_id = #{serviceId}
        </if>
        <if test='userName != null and userName != ""'>
            AND u.name LIKE '%${userName}%'
        </if>
        <if test='applicantName != null and applicantName != ""'>
            AND (ap.surname LIKE '%${applicantName}%' OR ap.firstname LIKE '%${applicantName}%' OR CONCAT(ap.firstname,
            ' ', ap.surname) = #{applicantName})
        </if>
        <if test="isPay != null">
            AND so.is_pay = #{isPay}
        </if>
        <if test="isSettle != null">
            AND so.is_settle = #{isSettle}
        </if>
        <if test="servicePackageId">
            AND so.service_package_id = #{servicePackageId}
        </if>
        ${orderBy}
        LIMIT #{offset}, #{rows};
    </select>

    <select id="listByParentId" resultType="org.zhinanzhen.b.dao.pojo.ServiceOrderDO">
        SELECT
        id,
        type,
        service_package_id AS servicePackageId,
        state
        FROM b_service_order
        WHERE is_delete = 0
        <if test='parentId != null and parentId > 0'>
            AND parent_id = #{parentId}
        </if>
        ORDER BY urgent_state DESC, gmt_create DESC;
    </select>
    
    <select id="listByApplicantParentId" resultType="org.zhinanzhen.b.dao.pojo.ServiceOrderDO">
        SELECT
        id,
        type,
        state
        FROM b_service_order
        WHERE is_delete = 0
        <if test='applicantParentId != null and applicantParentId > 0'>
            AND applicant_parent_id = #{applicantParentId}
        </if>
        ORDER BY urgent_state DESC, gmt_create DESC;
    </select>

    <select id="getServiceOrderById" parameterType="java.lang.Integer"
            resultType="org.zhinanzhen.b.dao.pojo.ServiceOrderDO">
        SELECT
            id,
            gmt_create AS gmtCreate,
            gmt_modify AS gmtModify,
            code,
            finish_date AS finishDate,
            type,
            people_number AS peopleNumber,
            people_type AS peopleType,
            people_remarks AS peopleRemarks,
            service_id AS serviceId,
            parent_id AS parentId,
            applicant_parent_id AS applicantParentId,
            service_package_id AS servicePackageId,
            school_id AS schoolId,
            course_id AS courseId,
            school_institution_location_id AS schoolInstitutionLocationId,
            institution_trading_name AS institutionTradingName,
            state,
            state_mark AS stateMark,
            state_mark2 AS stateMark2,
            urgent_state AS urgentState,
            mara_approval_date AS maraApprovalDate,
            submit_mara_approval_date AS submitMaraApprovalDate,
            official_approval_date AS officialApprovalDate,
            is_settle AS isSettle,
            is_deposit_user AS isDepositUser,
            is_submitted AS isSubmitted,
            subagency_id AS subagencyId,
            is_pay AS isPay,
            receive_type_id AS receiveTypeId,
            receive_date AS receiveDate,
            receivable,
            discount,
            received,
            installment,
            payment_voucher_image_url_1 AS paymentVoucherImageUrl1,
            payment_voucher_image_url_2 AS paymentVoucherImageUrl2,
            payment_voucher_image_url_3 AS paymentVoucherImageUrl3,
            payment_voucher_image_url_4 AS paymentVoucherImageUrl4,
            payment_voucher_image_url_5 AS paymentVoucherImageUrl5,
            coe_payment_voucher_image_url_1 AS coePaymentVoucherImageUrl1,
            coe_payment_voucher_image_url_2 AS coePaymentVoucherImageUrl2,
            coe_payment_voucher_image_url_3 AS coePaymentVoucherImageUrl3,
            coe_payment_voucher_image_url_4 AS coePaymentVoucherImageUrl4,
            coe_payment_voucher_image_url_5 AS coePaymentVoucherImageUrl5,
            invoice_voucher_image_url1 AS invoiceVoucherImageUrl1,
            invoice_voucher_image_url2 AS invoiceVoucherImageUrl2,
            invoice_voucher_image_url3 AS invoiceVoucherImageUrl3,
            invoice_voucher_image_url4 AS invoiceVoucherImageUrl4,
            invoice_voucher_image_url5 AS invoiceVoucherImageUrl5,
            visa_voucher_image_url AS visaVoucherImageUrl,
            kj_payment_image_url1 AS kjPaymentImageUrl1,
            kj_payment_image_url2 AS kjPaymentImageUrl2,
            low_price_image_url AS lowPriceImageUrl,
            per_amount AS perAmount,
            amount,
            expect_amount AS expectAmount,
            currency,
            exchange_rate AS exchangeRate,
            gst,
            deduct_gst AS deductGst,
            bonus,
            user_id AS userId,
            applicant_id AS applicantId,
            mara_id AS maraId,
            adviser_id AS adviserId,
            adviser_id_2 AS adviserId2,
            official_id AS officialId,
            remarks,
            refuse_reason AS refuseReason,
            closed_reason AS closedReason,
            information  ,
            is_history AS isHistory,
            nut_cloud AS nutCloud,
            service_assess_id AS serviceAssessId ,
            real_people_number AS realPeopleNumber ,
            verify_code AS verifyCode ,
            readcommitted_date AS readcommittedDate,
            ref_no AS refNo,
            EOI_number AS EOINumber,
            binding_order AS bindingOrder,
            offer_type AS offerType,
            offer_url AS offerUrl
        FROM b_service_order WHERE id = #{id, jdbcType=INTEGER};
    </select>

    <select id="countServiceOrderByApplicantId" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        SELECT count(*)
        FROM b_service_order WHERE applicant_id = #{applicantId, jdbcType=INTEGER};
    </select>

    <delete id="deleteServiceOrderById" parameterType="java.lang.Integer">
        DELETE b_service_order,b_service_order_comment,b_service_order_review,b_visa,b_visa_comment,b_commission_order,b_commission_order_comment
        FROM b_service_order
        LEFT JOIN b_service_order_comment ON b_service_order.id = b_service_order_comment.service_order_id
        LEFT JOIN b_service_order_review ON b_service_order.id = b_service_order_review.service_order_id
        LEFT join b_visa on b_service_order.id = b_visa.service_order_id
        left join b_visa_comment on b_visa.id = b_visa_comment.visa_id
        left join b_commission_order on b_service_order.id = b_commission_order.service_order_id
        left join b_commission_order_comment on b_commission_order.id = b_commission_order_comment.commission_order_id
        WHERE b_service_order.id = #{id, jdbcType=INTEGER};
    </delete>

    <update id="finishServiceOrder" parameterType="java.lang.Integer">
        UPDATE b_service_order
        SET gmt_modify = now(), finish_date = now()
        WHERE id = #{id, jdbcType=INTEGER};
    </update>

    <update id="ReadcommittedServiceOrder" parameterType="java.lang.Integer">
        UPDATE b_service_order
        SET gmt_modify = now(), readcommitted_date = now()
        WHERE id = #{id, jdbcType=INTEGER};
    </update>


    <update id="updateOffice">
        UPDATE b_service_order
        SET gmt_modify = now(),
            official_id= #{officialId}
        where id = #{id}

    </update>

    <select id="listServiceOrderGroupByForRegion" resultType="org.zhinanzhen.b.dao.pojo.EachRegionNumberDO">
        SELECT
        count( so.id ) AS count,
        tr.`name` AS name,
        <if test='regionId != null and regionId > 0'>
            a.`name` AS adviserName,
        </if>
        <choose>
            <when test=" type!=null and type!='' and type == 'OVST' ">
                bsc.`name` AS code,
                school_id AS serviceId
                FROM
                tb_adviser a,
                b_service_order so,
                tb_region tr,
                b_school bsc
            </when>
            <when test=" type!=null and type!='' and type == 'VISA' ">
                so.service_package_id AS servicePackageId,
                <![CDATA[ CONCAT(bs.`code`, ' - ', bs.`name`, IF(bsa.name <> '', CONCAT(' - ', bsa.name), '')) AS code, ]]>
                so.service_id AS serviceId
                FROM
                b_service_order so
                LEFT JOIN b_service_assess bsa ON so.service_assess_id = bsa.id
                LEFT JOIN tb_adviser a ON so.adviser_id = a.id
                LEFT JOIN tb_region tr ON a.region_id = tr.id
                LEFT JOIN b_service bs ON so.service_id = bs.id
            </when>
        </choose>
        WHERE
        so.is_delete = 0
        AND a.id = so.adviser_id
        <if test=" type != null and type != ''">
            AND type = #{type}
        </if>
        <if test=" type!=null and type!='' and type == 'OVST' ">
            AND so.parent_id = 0
        </if>
        AND so.state != 'PENDING'
        AND tr.id = a.region_id
        <choose>
            <when test=" type!=null and type!='' and type == 'OVST' ">
                AND school_id = bsc.id
            </when>
            <when test=" type!=null and type!='' and type == 'VISA' ">
                AND so.service_id = bs.id
            </when>
        </choose>
        <if test='startOfficialApprovalDate != null and startOfficialApprovalDate != "" and endOfficialApprovalDate != null and endOfficialApprovalDate != ""'>
            <![CDATA[ AND so.official_approval_date > #{startOfficialApprovalDate} AND so.official_approval_date < #{endOfficialApprovalDate} ]]>
        </if>
        <if test='regionId != null and regionId > 0'>
            AND a.region_id = #{regionId}
        </if>
        <choose>
            <when test=" type!=null and type!='' and type == 'OVST' ">
                GROUP BY
                bsc.name,
                tr.`name`
            </when>
            <when test=" type!=null and type!='' and type == 'VISA' ">
                GROUP BY
                so.service_id,
                so.service_package_id,
                tr.`name`,
                bsa.`name`
            </when>
        </choose>
        <if test='regionId != null and regionId > 0'>
            ,a.`name`
        </if>
    </select>

    <select id="listByVerifyCode" resultType="org.zhinanzhen.b.dao.pojo.ServiceOrderDO">
        SELECT
            id,
            gmt_create AS gmtCreate,
            gmt_modify AS gmtModify,
            code,
            finish_date AS finishDate,
            type,
            people_number AS peopleNumber,
            people_type AS peopleType,
            people_remarks AS peopleRemarks,
            service_id AS serviceId,
            parent_id AS parentId,
            applicant_parent_id AS applicantParentId,
            service_package_id AS servicePackageId,
            school_id AS schoolId,
            course_id AS courseId,
            school_institution_location_id AS schoolInstitutionLocationId,
            institution_trading_name AS institutionTradingName,
            state,
            urgent_state AS urgentState,
            mara_approval_date AS maraApprovalDate,
            submit_mara_approval_date AS submitMaraApprovalDate,
            official_approval_date AS officialApprovalDate,
            is_settle AS isSettle,
            is_deposit_user AS isDepositUser,
            is_submitted AS isSubmitted,
            subagency_id AS subagencyId,
            is_pay AS isPay,
            receive_type_id AS receiveTypeId,
            receive_date AS receiveDate,
            receivable,
            discount,
            received,
            installment,
            payment_voucher_image_url_1 AS paymentVoucherImageUrl1,
            payment_voucher_image_url_2 AS paymentVoucherImageUrl2,
            payment_voucher_image_url_3 AS paymentVoucherImageUrl3,
            payment_voucher_image_url_4 AS paymentVoucherImageUrl4,
            payment_voucher_image_url_5 AS paymentVoucherImageUrl5,
            coe_payment_voucher_image_url_1 AS coePaymentVoucherImageUrl1,
            coe_payment_voucher_image_url_2 AS coePaymentVoucherImageUrl2,
            coe_payment_voucher_image_url_3 AS coePaymentVoucherImageUrl3,
            coe_payment_voucher_image_url_4 AS coePaymentVoucherImageUrl4,
            coe_payment_voucher_image_url_5 AS coePaymentVoucherImageUrl5,
            visa_voucher_image_url AS visaVoucherImageUrl,
            invoice_voucher_image_url1 AS invoiceVoucherImageUrl1,
            invoice_voucher_image_url2 AS invoiceVoucherImageUrl2,
            invoice_voucher_image_url3 AS invoiceVoucherImageUrl3,
            invoice_voucher_image_url4 AS invoiceVoucherImageUrl4,
            invoice_voucher_image_url5 AS invoiceVoucherImageUrl5,
            kj_payment_image_url1 AS kjPaymentImageUrl1,
            kj_payment_image_url2 AS kjPaymentImageUrl2,
            low_price_image_url AS lowPriceImageUrl,
            per_amount AS perAmount,
            amount,
            expect_amount AS expectAmount,
            currency,
            exchange_rate AS exchangeRate,
            gst,
            deduct_gst AS deductGst,
            bonus,
            user_id AS userId,
            applicant_id AS applicantId,
            mara_id AS maraId,
            adviser_id AS adviserId,
            adviser_id_2 AS adviserId2,
            official_id AS officialId,
            remarks,
            refuse_reason AS refuseReason,
            closed_reason AS closedReason,
            information  ,
            is_history AS isHistory,
            nut_cloud AS nutCloud,
            service_assess_id AS serviceAssessId ,
            real_people_number AS realPeopleNumber ,
            verify_code AS verifyCode ,
            readcommitted_date AS readcommittedDate,
            ref_no AS refNo
        FROM b_service_order WHERE verify_code = #{verifyCode};
    </select>

    <select id="eachSubjectCount" resultType="org.zhinanzhen.b.dao.pojo.EachSubjectCountDO">
        SELECT
        bs.`name`,
        bs.`subject`,
        COUNT( bso.id ) AS number
        FROM
        `b_service_order` bso,
        b_school bs
        WHERE
        bso.school_id = bs.id
        AND bso.type = 'OVST'
        <if test='startOfficialApprovalDate != null and startOfficialApprovalDate != "" and endOfficialApprovalDate != null and endOfficialApprovalDate != ""'>
            <![CDATA[ AND bso.official_approval_date > #{startOfficialApprovalDate} AND bso.official_approval_date < #{endOfficialApprovalDate} ]]>
        </if>
        GROUP BY
        bs.id;
    </select>

    <select id="NotReviewedServiceOrder" resultType="org.zhinanzhen.b.dao.pojo.ServiceOrderDO">
        SELECT
        so.id AS id,
        so.gmt_create AS gmtCreate,
        so.gmt_modify AS gmtModify,
        so.code AS code,
        so.finish_date AS finishDate,
        so.type AS type,
        so.people_number AS peopleNumber,
        so.people_type AS peopleType,
        so.people_remarks AS peopleRemarks,
        so.service_id AS serviceId,
        so.parent_id AS parentId,
        so.applicant_parent_id AS applicantParentId,
        so.service_package_id AS servicePackageId,
        so.school_id AS schoolId,
        so.course_id AS courseId,
        so.school_institution_location_id AS schoolInstitutionLocationId,
        so.institution_trading_name AS institutionTradingName,
        so.state AS state,
        so.state_mark AS stateMark,
        so.state_mark2 AS state_mark2,
        so.urgent_state AS urgentState,
        so.mara_approval_date AS maraApprovalDate,
        so.submit_mara_approval_date AS submitMaraApprovalDate,
        so.official_approval_date AS officialApprovalDate,
        so.is_settle AS isSettle,
        so.is_deposit_user AS isDepositUser,
        so.is_submitted AS isSubmitted,
        so.subagency_id AS subagencyId,
        so.is_pay AS isPay,
        so.receive_type_id AS receiveTypeId,
        so.receive_date AS receiveDate,
        so.receivable AS receivable,
        so.discount AS discount,
        so.received AS received,
        so.installment AS installment,
        so.payment_voucher_image_url_1 AS paymentVoucherImageUrl1,
        so.payment_voucher_image_url_2 AS paymentVoucherImageUrl2,
        so.payment_voucher_image_url_3 AS paymentVoucherImageUrl3,
        so.payment_voucher_image_url_4 AS paymentVoucherImageUrl4,
        so.payment_voucher_image_url_5 AS paymentVoucherImageUrl5,
        so.coe_payment_voucher_image_url_1 AS coePaymentVoucherImageUrl1,
        so.coe_payment_voucher_image_url_2 AS coePaymentVoucherImageUrl2,
        so.coe_payment_voucher_image_url_3 AS coePaymentVoucherImageUrl3,
        so.coe_payment_voucher_image_url_4 AS coePaymentVoucherImageUrl4,
        so.coe_payment_voucher_image_url_5 AS coePaymentVoucherImageUrl5,
        so.visa_voucher_image_url AS visaVoucherImageUrl,
        so.invoice_voucher_image_url1 AS invoiceVoucherImageUrl1,
        so.invoice_voucher_image_url2 AS invoiceVoucherImageUrl2,
        so.invoice_voucher_image_url3 AS invoiceVoucherImageUrl3,
        so.invoice_voucher_image_url4 AS invoiceVoucherImageUrl4,
        so.invoice_voucher_image_url5 AS invoiceVoucherImageUrl5,
        so.kj_payment_image_url1 AS kjPaymentImageUrl1,
        so.kj_payment_image_url2 AS kjPaymentImageUrl2,
        so.low_price_image_url AS lowPriceImageUrl,
        so.per_amount AS perAmount,
        so.amount AS amount,
        so.expect_amount AS expectAmount,
        so.currency,
        so.exchange_rate AS exchangeRate,
        so.gst AS gst,
        so.deduct_gst AS deductGst,
        so.bonus AS bonus,
        so.user_id AS userId,
        so.applicant_id AS applicantId,
        so.mara_id AS maraId,
        so.adviser_id AS adviserId,
        so.adviser_id_2 AS adviserId2,
        so.official_id AS officialId,
        so.remarks AS remarks,
        so.refuse_reason AS refuseReason,
        so.closed_reason AS closedReason,
        so.information AS information ,
        so.is_history AS isHistory,
        so.nut_cloud AS nutCloud,
        so.service_assess_id AS serviceAssessId ,
        so.real_people_number AS realPeopleNumber ,
        so.verify_code AS verifyCode ,
        so.readcommitted_date AS readcommittedDate,
        so.ref_no AS refNo
        FROM tb_user u, tb_adviser a, b_service_order so LEFT JOIN b_service_order_official_tag soot ON
        so.id=soot.service_order_id
        WHERE so.is_delete = 0 AND a.id = so.adviser_id AND u.id = so.user_id AND so.type != 'SIV' AND so.type != 'NSV'
        AND so.state = 'REVIEW'
        <![CDATA[ AND DATE_SUB(NOW(),INTERVAL 1 day)  >  official_approval_date ]]>
        <if test="officialId != null and officialId > 0">
            AND so.official_id = #{officialId}
        </if>
        <if test="thisMonth != null and thisMonth == true">
            AND DATE_FORMAT(official_approval_date, '%Y%m') = DATE_FORMAT(CURDATE(), '%Y%m')
        </if>
        <if test="thisMonth != null and thisMonth == false">
            LIMIT 20
        </if>
        ;
    </select>

    <select id="caseCount" resultType="java.lang.Integer">
        SELECT
        count(so.id)
        FROM tb_user u, tb_adviser a, b_service_order so LEFT JOIN b_service_order_official_tag soot ON
        so.id=soot.service_order_id
        WHERE so.is_delete = 0 AND a.id = so.adviser_id AND u.id = so.user_id
        <if test="officialId != null and officialId > 0">
            AND so.official_id = #{officialId}
        </if>
        <choose>
            <when test='days != null and days == "M"'>
                AND DATE_FORMAT(official_approval_date, '%Y%m') = DATE_FORMAT(CURDATE(), '%Y%m')
            </when>
            <when test='days != null and days == "W"'>
                AND YEARWEEK(official_approval_date,1) = YEARWEEK(NOW(),1)
            </when>
        </choose>
        <if test='state != null and state == "OREVIEW"'>
            AND so.state != 'PENDING'
        </if>
        <if test='state != null and state == "COMPLETE"'>
            AND so.state = 'COMPLETE'
        </if>
        ;
    </select>

    <select id="listServiceOrderToAnalysis" resultType="org.zhinanzhen.b.dao.pojo.AdviserServiceCountDO">
        SELECT
        count( so.id ) AS count,
        type,
        service_id AS serviceId,
        school_id AS schoolId,
        service_package_id AS servicePackageId ,
        so.adviser_id AS adviserId ,
        r.name AS regionName
        FROM
        b_service_order so,tb_adviser a,tb_region r
        WHERE
        so.is_delete = 0 AND a.id = so.adviser_id AND a.state = 'ENABLED' AND a.region_id = r.id
        <if test="typeList != null">
            AND so.type IN
            <foreach collection="typeList" index="index" open="(" close=")" separator="," item="type">
                #{type}
            </foreach>
        </if>
        <if test="month != null">
            AND DATE_FORMAT(so.official_approval_date,'%Y%c') = CONCAT(DATE_FORMAT(NOW(),'%Y'),#{month})
        </if>
        <if test="regionIdList != null">
            AND r.id IN
            <foreach collection="regionIdList" item="regionId" separator="," close=")" open="(" index="index">
                #{regionId}
            </foreach>
        </if>
        GROUP BY
        so.adviser_id,
        service_id,
        school_id,
        service_package_id
        ;
    </select>

    <select id="listOvstServiceOrderGroupByForRegion" resultType="org.zhinanzhen.b.dao.pojo.EachRegionNumberDO">
        SELECT
        count( so.id ) AS count,
        tr.`name` AS name,
        bsi.name AS instiName,
        bsi.institution_trading_name AS institutionTradingName,
        bsi.institution_name AS institutionName,
        <if test='regionId != null and regionId > 0'>
            a.`name` AS adviserName,
        </if>
        course_id AS serviceId
        FROM tb_adviser a,b_service_order so,tb_region tr,b_school_course bsc,b_school_institution bsi
        WHERE so.is_delete = 0
        AND a.id = so.adviser_id AND type = 'OVST' AND so.parent_id = 0
        AND so.state != 'PENDING' AND tr.id = a.region_id AND course_id = bsc.id AND bsi.id = bsc.provider_id
        <if test='regionId != null and regionId > 0'>
            AND a.region_id = #{regionId}
        </if>
        <if test='startOfficialApprovalDate != null and startOfficialApprovalDate != "" and endOfficialApprovalDate != null and endOfficialApprovalDate != ""'>
            <![CDATA[ AND so.official_approval_date > #{startOfficialApprovalDate} AND so.official_approval_date < #{endOfficialApprovalDate} ]]>
        </if>
        <if test='regionId != null and regionId > 0' >
            AND a.region_id = #{regionId}
        </if>
        GROUP BY bsi.id , tr.`name`
        <if test='regionId != null and regionId > 0'>
            ,a.`name`
        </if>
    </select>
    <select id="getCommissionOrderList" resultType="org.zhinanzhen.b.dao.pojo.VisaDO">
        SELECT
            bv.id AS id,
            bv.gmt_create AS gmtCreate,
            bv.code AS code,
            bv.handling_date AS handlingDate,
            bv.user_id AS userId,
            bv.state AS state,
            bv.commission_state AS commissionState,
            bv.kj_approval_date AS kjApprovalDate,
            bv.receive_type_id AS receiveTypeId,
            bv.receive_date AS receiveDate,
            bv.service_id AS serviceId,
            bv.service_order_id AS serviceOrderId,
            bv.installment_num AS installmentNum,
            bv.installment,
            bv.payment_voucher_image_url_1 AS paymentVoucherImageUrl1,
            bv.payment_voucher_image_url_2 AS paymentVoucherImageUrl2,
            bv.payment_voucher_image_url_3 AS paymentVoucherImageUrl3,
            bv.payment_voucher_image_url_4 AS paymentVoucherImageUrl4,
            bv.payment_voucher_image_url_5 AS paymentVoucherImageUrl5,
            bv.visa_voucher_image_url AS visaVoucherImageUrl,
            bv.receivable AS receivable,
            bv.received AS received,
            bv.per_amount AS perAmount,
            bv.amount AS amount,
            bv.expect_amount AS expectAmount,
            bv.sure_expect_amount AS sureExpectAmount,
            bv.currency,
            bv.exchange_rate AS exchangeRate,
            bv.discount AS discount,
            bv.invoice_number AS invoiceNumber,
            bv.gst AS gst,
            bv.deduct_gst AS deductGst,
            bv.bonus AS bonus,
            bv.bonus_date AS bonusDate,
            bv.adviser_id AS adviserId,
            bv.mara_id AS maraId,
            bv.official_id AS officialId,
            bv.bank_check AS bankCheck,
            bv.is_checked AS isChecked,
            bv.remarks AS remarks,
            bv.refuse_reason AS refuseReason,
            bv.verify_code AS verifyCode,
            bv.bank_date AS bankDate,
            bv.is_close AS isClose,
            bv.invoice_create AS invoiceCreate,
            tbu.name AS userName,
            tbu.birthday AS birthday,
            tbu.phone AS phone,
            so.applicant_id AS applicantId
        FROM b_visa bv, tb_user tbu, tb_adviser a, b_service_order so LEFT JOIN b_applicant ap ON ap.id = so.applicant_id
        WHERE bv.user_id = tbu.id AND a.id = bv.adviser_id AND bv.service_order_id = so.id
        and
            so.id = #{id}
        and bv.state !="PENDING"


    </select>
    <select id="OfficialHandoverServiceOrder" resultType="org.zhinanzhen.b.dao.pojo.ServiceOrderDO">
        SELECT
            id
        FROM
            `b_service_order`
        WHERE
            official_id = #{officialId}
          AND type = 'VISA'
          AND state NOT IN ('COMPLETE','PAID','COMPLETE_FD','CLOSE')
    </select>

    <select id="ApplicantListByServiceOrderId" resultType="org.zhinanzhen.b.dao.pojo.ApplicantListDO">
        SELECT
            id,
            applicant_id AS applicantId,
            applicant_parent_id AS applicantParentId,
            service_package_id AS servicePackageId
        FROM
            b_service_order
        WHERE
            applicant_parent_id = #{serviceOrderId}
        OR
            id = #{serviceOrderId}
        GROUP BY applicant_id;
    </select>

    <select id="getDeriveOrder" resultMap="ServicePackage">
        SELECT
            so.id AS id,
            so.gmt_create AS gmtCreate,
            so.gmt_modify AS gmtModify,
            so.code AS code,
            so.finish_date AS finishDate,
            so.type AS type,
            so.people_number AS peopleNumber,
            so.people_type AS peopleType,
            so.people_remarks AS peopleRemarks,
            so.service_id AS serviceId,
            so.parent_id AS parentId,
            so.applicant_parent_id AS applicantParentId,
            so.service_package_id AS servicePackageId,
            so.school_id AS schoolId,
            so.course_id AS courseId,
            so.school_institution_location_id AS schoolInstitutionLocationId,
            so.institution_trading_name AS institutionTradingName,
            so.state AS state,
            so.state_mark AS stateMark,
            so.state_mark2 AS stateMark2,
            so.urgent_state AS urgentState,
            so.mara_approval_date AS maraApprovalDate,
            so.submit_mara_approval_date AS submitMaraApprovalDate,
            so.official_approval_date AS officialApprovalDate,
            so.is_settle AS isSettle,
            so.is_deposit_user AS isDepositUser,
            so.is_submitted AS isSubmitted,
            so.subagency_id AS subagencyId,
            so.is_pay AS isPay,
            so.receive_type_id AS receiveTypeId,
            so.receive_date AS receiveDate,
            so.receivable AS receivable,
            so.discount AS discount,
            so.received AS received,
            so.installment AS installment,
            so.payment_voucher_image_url_1 AS paymentVoucherImageUrl1,
            so.payment_voucher_image_url_2 AS paymentVoucherImageUrl2,
            so.payment_voucher_image_url_3 AS paymentVoucherImageUrl3,
            so.payment_voucher_image_url_4 AS paymentVoucherImageUrl4,
            so.payment_voucher_image_url_5 AS paymentVoucherImageUrl5,
            so.coe_payment_voucher_image_url_1 AS coePaymentVoucherImageUrl1,
            so.coe_payment_voucher_image_url_2 AS coePaymentVoucherImageUrl2,
            so.coe_payment_voucher_image_url_3 AS coePaymentVoucherImageUrl3,
            so.coe_payment_voucher_image_url_4 AS coePaymentVoucherImageUrl4,
            so.coe_payment_voucher_image_url_5 AS coePaymentVoucherImageUrl5,
            so.visa_voucher_image_url AS visaVoucherImageUrl,
            so.invoice_voucher_image_url1 AS invoiceVoucherImageUrl1,
            so.invoice_voucher_image_url2 AS invoiceVoucherImageUrl2,
            so.invoice_voucher_image_url3 AS invoiceVoucherImageUrl3,
            so.invoice_voucher_image_url4 AS invoiceVoucherImageUrl4,
            so.invoice_voucher_image_url5 AS invoiceVoucherImageUrl5,
            so.kj_payment_image_url1 AS kjPaymentImageUrl1,
            so.kj_payment_image_url2 AS kjPaymentImageUrl2,
            so.low_price_image_url AS lowPriceImageUrl,
            so.per_amount AS perAmount,
            so.amount AS amount,
            so.expect_amount AS expectAmount,
            so.currency,
            so.exchange_rate AS exchangeRate,
            so.gst AS gst,
            so.deduct_gst AS deductGst,
            so.bonus AS bonus,
            so.user_id AS userId,
            so.applicant_id AS applicantId,
            so.mara_id AS maraId,
            so.adviser_id AS adviserId,
            so.adviser_id_2 AS adviserId2,
            so.official_id AS officialId,
            so.remarks AS remarks,
            so.refuse_reason AS refuseReason,
            so.closed_reason AS closedReason,
            so.information AS information ,
            so.is_history AS isHistory,
            so.nut_cloud AS nutCloud,
            so.service_assess_id AS serviceAssessId ,
            so.real_people_number AS realPeopleNumber ,
            so.verify_code AS verifyCode ,
            so.readcommitted_date AS readcommittedDate,
            so.ref_no AS refNo,
            so.EOI_number AS EOINumber,
            bsp.id AS bspId,
            bsp.type AS bspType,
            bsp.service_id AS bspServiceId
        FROM
            b_service_order so, b_service_package bsp
        WHERE
            so.service_package_id = bsp.id
        AND
            so.applicant_parent_id = #{id,jdbcType=INTEGER}
    </select>

    <select id="getTmpServiceOrder" resultType="org.zhinanzhen.b.dao.pojo.ServiceOrderDO">
        select id,state from b_service_order
                        where readcommitted_date between #{beforeFormat} and #{nowDate}
                          and (state = 'APPLY' OR state = 'COMPLETE')
                            and official_id != 0
    </select>

    <resultMap id="ServicePackage" type="org.zhinanzhen.b.service.pojo.ServiceOrderDTO">
        <id column="id" property="id"></id>
        <result column="gmtCreate" property="gmtCreate"></result>
        <result column="gmtModify" property="gmtModify"></result>
        <result column="code" property="code"></result>
        <result column="finishDate" property="finishDate"></result>
        <result column="type" property="type"></result>
        <result column="peopleNumber" property="peopleNumber"></result>
        <result column="peopleType" property="peopleType"></result>
        <result column="peopleRemarks" property="peopleRemarks"></result>
        <result column="serviceId" property="serviceId"></result>
        <result column="parentId" property="parentId"></result>
        <result column="applicantParentId" property="applicantParentId"></result>
        <result column="servicePackageId" property="servicePackageId"></result>
        <result column="schoolId" property="schoolId"></result>
        <result column="courseId" property="courseId"></result>
        <result column="schoolInstitutionLocationId" property="schoolInstitutionLocationId"></result>
        <result column="institutionTradingName" property="institutionTradingName"></result>
        <result column="state" property="state"></result>
        <result column="stateMark" property="stateMark"></result>
        <result column="stateMark2" property="stateMark2"></result>
        <result column="urgentState" property="urgentState"></result>
        <result column="maraApprovalDate" property="maraApprovalDate"></result>
        <result column="submitMaraApprovalDate" property="submitMaraApprovalDate"></result>
        <result column="officialApprovalDate" property="officialApprovalDate"></result>
        <result column="isSettle" property="isSettle"></result>
        <result column="isDepositUser" property="isDepositUser"></result>
        <result column="isSubmitted" property="isSubmitted"></result>
        <result column="subagencyId" property="subagencyId"></result>
        <result column="isPay" property="isPay"></result>
        <result column="receiveTypeId" property="receiveTypeId"></result>
        <result column="receiveDate" property="receiveDate"></result>
        <result column="receivable" property="receivable"></result>
        <result column="discount" property="discount"></result>
        <result column="received" property="received"></result>
        <result column="installment" property="installment"></result>
        <result column="paymentVoucherImageUrl1" property="paymentVoucherImageUrl1"></result>
        <result column="paymentVoucherImageUrl2" property="paymentVoucherImageUrl2"></result>
        <result column="paymentVoucherImageUrl3" property="paymentVoucherImageUrl3"></result>
        <result column="paymentVoucherImageUrl4" property="paymentVoucherImageUrl4"></result>
        <result column="paymentVoucherImageUrl5" property="paymentVoucherImageUrl5"></result>
        <result column="coePaymentVoucherImageUrl1" property="coePaymentVoucherImageUrl1"></result>
        <result column="coePaymentVoucherImageUrl2" property="coePaymentVoucherImageUrl2"></result>
        <result column="coePaymentVoucherImageUrl3" property="coePaymentVoucherImageUrl3"></result>
        <result column="coePaymentVoucherImageUrl4" property="coePaymentVoucherImageUrl4"></result>
        <result column="coePaymentVoucherImageUrl5" property="coePaymentVoucherImageUrl5"></result>
        <result column="visaVoucherImageUrl" property="visaVoucherImageUrl"></result>
        <result column="invoiceVoucherImageUrl1" property="invoiceVoucherImageUrl1"></result>
        <result column="invoiceVoucherImageUrl2" property="invoiceVoucherImageUrl2"></result>
        <result column="invoiceVoucherImageUrl3" property="invoiceVoucherImageUrl3"></result>
        <result column="invoiceVoucherImageUrl4" property="invoiceVoucherImageUrl4"></result>
        <result column="invoiceVoucherImageUrl5" property="invoiceVoucherImageUrl5"></result>
        <result column="kjPaymentImageUrl1" property="kjPaymentImageUrl1"></result>
        <result column="kjPaymentImageUrl2" property="kjPaymentImageUrl2"></result>
        <result column="lowPriceImageUrl" property="lowPriceImageUrl"></result>
        <result column="perAmount" property="perAmount"></result>
        <result column="amount" property="amount"></result>
        <result column="expectAmount" property="expectAmount"></result>
        <result column="currency" property="currency"></result>
        <result column="exchangeRate" property="exchangeRate"></result>
        <result column="gst" property="gst"></result>
        <result column="deductGst" property="deductGst"></result>
        <result column="bonus" property="bonus"></result>
        <result column="userId" property="userId"></result>
        <result column="applicantId" property="applicantId"></result>
        <result column="maraId" property="maraId"></result>
        <result column="adviserId" property="adviserId"></result>
        <result column="adviserId2" property="adviserId2"></result>
        <result column="officialId" property="officialId"></result>
        <result column="remarks" property="remarks"></result>
        <result column="refuseReason" property="refuseReason"></result>
        <result column="closedReason" property="closedReason"></result>
        <result column="information" property="information"></result>
        <result column="isHistory" property="isHistory"></result>
        <result column="nutCloud" property="nutCloud"></result>
        <result column="serviceAssessId" property="serviceAssessId"></result>
        <result column="realPeopleNumber" property="realPeopleNumber"></result>
        <result column="verifyCode" property="verifyCode"></result>
        <result column="readcommittedDate" property="readcommittedDate"></result>
        <result column="refNo" property="refNo"></result>
        <result column="visaVoucherImageUrl" property="visaVoucherImageUrl"></result>
        <result column="EOINumber" property="EOINumber"></result>
        <association property="servicePackage" javaType="org.zhinanzhen.b.service.pojo.ServicePackageDTO">
            <id column="bspId" property="id"></id>
            <result column="bspType" property="type"></result>
            <result column="bspServiceId" property="serviceId"></result>
        </association>
    </resultMap>
</mapper>
