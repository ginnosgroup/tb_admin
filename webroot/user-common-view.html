<meta charset="utf-8"/>
<div id="app_sub">
<div class="modal fade" id="show_addnewservice1_id" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
			<div class="modal-dialog" role="document" style="width:700px;">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel">服务详情页</h4>
					</div>
					<div id="alert_success" class="alert alert-success fade in" style="display:none;position:absolute;z-index:9999;">
			      <button data-dismiss="alert" class="close close-sm" type="button">
			      <i class="fa fa-times"></i>
			      </button>
			      <strong id="success_info">Success! You  just achieved success.</strong>
			  	</div>
			  	<div id="alert_error" class="alert alert-block alert-danger fade in" style="display:none;position:absolute;z-index:9999;">
		        <button data-dismiss="alert" class="close close-sm" type="button">
		        <i class="fa fa-times"></i>
		        </button>
		        <strong id="error_info"></strong>
		      </div>
					<div class="modal-body">
							<form class="form-inline" style="">
							<input type="hidden" name="user_id" id="user_id" value="0" />
							<input type="hidden" name="service_id" id="service_id" value="0" />
							<input type="hidden" name="flist" id="flist" value="" />
							<div class="form-group" style="width:100%;height:40px;">
								<label class="control-label" style="width:80px;"><strong>客户姓名：</strong></label>								
								<label id="b1"></label>
							</div>
							<div class="form-group" style="width:100%;height:40px;">
								<label class="control-label" style="width:80px;"><strong>顾问：</strong></label>
								<label id="b2" style="width:100px;"></label>
								<label class="control-label"><strong>Mara：</label>
								<label id="b3" style="width:100px;"></label>
								<label class="control-label"><strong>文案：</label>
								<label id="b4" style="width:100px;"></label>
							</div>
							<div class="form-group" style="width:100%;height:40px;">
								<label class="control-label" style="width:80px;"><strong>服务项目：</strong></label>
								<label id="b5">签证</label> - 
								<label id="b6"></label>						
							</div>
							<div class="form-group" style="width:100%;height:40px;">
								<label class="control-label" style="width:80px;"><strong>是否已支付：</strong></label>
								<label id="b7"></label>
							</div>
							<div v-if="ap_list==='GW' || ap_list==='null'" id="show_paid" style="width:100%;display:none;">
							<hr/>
							<div class="form-group" style="width:100%;">								
									<label class="control-label" style="width:80px;"><strong>收款日期：</strong></label>
									<label id="b8" style="width:100px;"></label>
									<label class="control-label"><strong>收款方式：</strong></label>
									<label id="b9" style="width:150px;"></label>
							</div>
							<div class="form-group" style="display:block;line-height:40px;">
									<div class="form-group">
										<label class="control-label" style="width:80px;"><strong>总计应收：</strong></label>
										$<label id="b10" style="width:80px;"></label>
									</div>									
									<div class="form-group" style="margin-left:10px;">
										<label class="control-label"><strong>总计收款：</strong></label>
										$<label id="b12" style="width:80px;"></label>
									</div>
									<div class="form-group" style="margin-left:10px;">
										<label class="control-label"><strong>付款次数：</strong></label>
										<label id="b13"></label>
									</div>
							</div>
							<div class="form-group" style="display:block;line-height:40px;">
									<div class="form-group" style="margin-left:10px;">
										<label class="control-label"><strong>本次应收：</strong></label>
										$<label id="b14a" style="width:80px;"></label>
									</div>
									<div class="form-group" style="margin-left:10px;">
										<label class="control-label"><strong>折扣：</strong></label>
										$<label id="b11" style="width:80px;"></label>
									</div>
									<div class="form-group">
										<label class="control-label" style="width:80px;"><strong>本次收款：</strong></label>
										$<label id="b14" style="width:80px;"></label>
									</div>
									<div class="form-group" style="margin-left:10px;">
										<label class="control-label"><strong>GST：</strong></label>
										$<label id="b15" style="width:80px;"></label>
									</div>
									<div class="form-group" style="margin-left:10px;">
										<label class="control-label"><strong>Deduct GST：</strong></label>
										$<label id="b16" style="width:65px;"></label>
									</div>
									<div class="form-group" style="">
										<label class="control-label"><strong>预收业绩</strong></label>
										$<label id="b17" style="width:50px;"></label>
									</div>
							</div>
							</div>
							<div id="show_visapic" class="form-group" style="display:none;width:100%;line-height:40px;">
								<label class="control-label"><strong>签证凭证：</strong></label>
								<label id="visapic_url"></label>
							</div>
							<hr/>
							<div class="form-group" style="width:100%;line-height:40px;">
								<label class="control-label"><strong>备注：</strong></label>
								<label id="b18" style="word-break:break-all;"></label>
							</div>
							<div>
									<div style="text-align: center;">流程进度条...待实现...</div>
							</div>
							<div v-if="ap_list==='WA'">
									<hr/>
									<div class="form-group" style="width:100%;line-height:40px;">
										<label class="control-label"><strong>状态：</strong></label>
										<select class="form-control" style="width:180px;" id="b19" onchange="changeVisaState(this.value);">
										<option v-if="flowstate_wa!=='WAIT' && flowstate_wa!=='COMPLETE'" value="">请选择</option>
										<option v-if="flowstate_gw==='REVIEW' && flowstate_wa===null" value="REVIEW">资料审核中</option>
										<option v-if="flowstate_wa==='REVIEW' && (flowstate_ma===null || flowstate_ma === 'REVIEW')" value="WAIT">提交Mara审核</option>
										<option v-if="flowstate_wa==='WAIT'" value="">Mara审核中</option>
										<option v-if="flowstate_ma==='FINISH'" value="APPLY">已提交申请</option>
										<option v-if="flowstate_wa==='APPLY' || flowstate_wa==='COMPLETE'" value="COMPLETE">申请成功</option>
										<option v-if="flowstate_wa!=='COMPLETE'" value="CLOSE">关闭申请</option>
										</select>
									</div>
									<div id="close_remarks" class="form-group" style="display:none;width:100%;line-height:40px;">
										<label class="control-label"><strong>备注：</strong></label>
										<textarea id="b101" class="form-control" style="width:98%"></textarea>							
									</div>
							</div>							
							</form>
					</div>
					<div class="modal-footer" style="text-align: center;">
							<dle v-if="ap_list==='GW'">
									<dle v-if="flowstate_gw==='REVIEW'">
									<button onclick="flowstep('PENDING',1)" type="button" class="btn btn-default">撤回</button>
									</dle>
							</dle>
							<dle v-if="ap_list==='WA'">
									<input type="file" id="f1a" style="display:none">
									<input type="hidden" id="flist" value="" />
									<div id="show_pic" style="display:none;padding-bottom:10px;"></div>
									<button onclick="upload_receipt_pic('f1a')" id="upload_certificate" type="button" class="btn btn-danger" style="display:none;">上传签证凭证</button>									
									<button v-if="flowstate_wa!=='WAIT' && flowstate_wa!='COMPLETE'" onclick="checkform('VISA');" type="button" class="btn btn-primary">提交</button>							
									<dle v-if="flowstate_gw==='REVIEW'">
											<button v-if="flowstate_wa===null" onclick="flowstep('PENDING',0)" id="btnRefuse" type="button" class="btn btn-default">驳回</button>
									</dle>									
									<dle v-if="flowstate_ma==='WAIT' || flowstate_wa==='WAIT'">
											<button onclick="flowstep('REVIEW',1)" id="btnCancel"  type="button" class="btn btn-default">撤回</button>
									</dle>									
							</dle>
							<dle v-if="ap_list==='MA'">
									<dle v-if="flowstate_ma==='WAIT' || flowstate_wa==='WAIT'">
											<button onclick="flowstep('FINISH',1)" type="button" class="btn btn-primary">通过</button>
											<button onclick="flowstep('REVIEW',0)" type="button" class="btn btn-default">驳回</button>
									</dle>
							</dle>						
							<button onclick="" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
					</div>
				</div>
			</div>
</div>

<div class="modal fade" id="show_addnewservice2_id" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
			<div class="modal-dialog" role="document" style="width:700px;">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel">服务详情页</h4>
					</div>
					<div id="alert_success" class="alert alert-success fade in" style="display:none;position:absolute;z-index:9999;">
			      <button data-dismiss="alert" class="close close-sm" type="button">
			      <i class="fa fa-times"></i>
			      </button>
			      <strong>Success!</strong> You  just achieved success.
			  	</div>
			  	<div id="alert_error" class="alert alert-block alert-danger fade in" style="display:none;position:absolute;z-index:9999;">
		        <button data-dismiss="alert" class="close close-sm" type="button">
		        <i class="fa fa-times"></i>
		        </button>
		        <strong id="error_info"></strong>
		      </div>
					<div class="modal-body">
							<form class="form-inline" style="">																											
							<div class="form-group" style="width:100%;height:40px;">
								<label class="control-label" style="width:80px;"><strong>客户姓名：</strong></label>								
								<label id="c1"></label>
							</div>
							<div class="form-group" style="width:100%;height:40px;">
								<label class="control-label" style="width:80px;"><strong>服务项目：</strong></label>
								<label id="c2" style="width:100px;">留学</strong></label>
								<label class="control-label"><strong>学校：</strong></label>
								<label id="c3" style="width:150px;"></label>
								<label class="control-label"><strong>课程：</strong></label>
								<label id="c4"></label>			
							</div>
							<div class="form-group" style="width:100%;height:40px;">
								<label class="control-label" style="width:80px;"><strong>提前扣佣：</strong></label>
								<label id="c5" style="width:50px;"></label>
								<label><strong>保证金客户：</strong></label>
								<label id="c6" style="width:50px;"></label>
								<label class="control-label" style="width:80px;margin-left:60px;"><strong>Subagency：</strong></label>								
								<select class="form-control" style="width:150px;" id="c7a"></select>	
								<label id="c7"></label>
							</div>
							<div class="form-group" style="width:100%;height:40px;">
								<label class="control-label" style="width:80px;"><strong>顾问：</strong></label>
								<label id="c8" style="width:100px;"></label>
								<label class="control-label"><strong>文案：</strong></label>
								<label id="c9" style="width:100px;"></label>
							</div>
							<div id="show_deposit_user" style="width:100%;display:none;">
							<div class="form-group" style="width:100%;height:40px;">
								<label class="control-label" style="width:120px;"><strong>保证金是否已支付：</strong></label>
								<label id="c10" style="width:100px;"></label>
							</div>
							<div class="form-group" style="width:100%;">								
									<label class="control-label" style="width:80px;"><strong>收款日期：</strong></label>
									<label id="c11" style="width:100px;"></label>
									<label class="control-label"><strong>收款方式：</strong></label>
									<label id="c12"></label>
							</div>
							<div class="form-group" style="display:block;line-height:40px;">
									<div class="form-group">
										<label class="control-label" style="width:80px;"><strong>总计应收：</strong></label>
										$<label id="c13" style="width:100px;"></label>
									</div>
									<div class="form-group" style="margin-left:10px;">
										<label class="control-label"><strong>折扣：</strong></label>
										$<label id="c14" style="width:100px;"></label>
									</div>
									<div class="form-group" style="margin-left:10px;">
										<label class="control-label"><strong>总计收款：</strong></label>
										$<label id="c15"></label>
									</div>									
							</div>							
							</div>
							<div id="show_paymentpic" class="form-group" style="display:;width:100%;line-height:40px;">
								<label class="control-label"><strong>COE收款凭证：</strong></label>
								<label id="paymentpic_url"></label>
							</div>
							<hr/>
							<div class="form-group" style="width:100%;line-height:40px;">
									<label class="control-label"><strong>备注：</strong></label>
									<textarea id="c16a" class="form-control" style="width:98%"></textarea>
									<label id="c16" style="word-break:break-all;"></label>									
							</div>							
							<div id="show_reqcommission" v-if="flowstate_wa==='PAID' && ap_list === 'GW' && !submitted" style="width:100%;margin-bottom:10px;display:;">
									<hr/>
									<div class="form-group" style="width:100%;line-height:40px;">
											<label class="control-label"><strong>佣金信息</strong></label>
									</div>
									<div class="form-group" style="width:100%;margin-top:10px;">								
											<label class="control-label" style="width:150px;">StudentID<span style="color:red;">*</span></label>
											<input type="text" autocomplete="off" id="c20" class="form-control" style="width:200px;font-weight:normal;" placeholder="请输入学生ID">							
									</div>
									<div class="form-group" style="width:100%;margin-top:10px;">								
											<label class="control-label" style="width:150px;">Installment：<span style="color:red;">*</span></label>
											<select class="form-control" style="width:70px;font-weight:normal;" id="c21" onchange="setInstallment(this.value)">
											<option value="1">1</option>
											<option value="2">2</option>
											<option value="3">3</option>
											</select>
									</div>
									<div class="form-group" style="width:100%;margin-top:10px;">								
											<label class="control-label" style="width:150px;">开课日期</label>
											<input type="text" autocomplete="off" id="c22" class="form-control default-date-picker" style="width:150px;font-weight:normal;" placeholder="请选择日期" data-date-format="yyyy-mm-dd">
											<label class="control-label" style="margin-left:40px;">结束日期</label>
											<input type="text" autocomplete="off" id="c23" class="form-control default-date-picker" style="width:150px;font-weight:normal;" placeholder="请选择日期" data-date-format="yyyy-mm-dd">								
									</div>
									<div class="form-group" style="width:100%;margin-top:10px;">								
											<label class="control-label" style="width:150px;">Installment 1<br/>Due Date<span style="color:red;">*</span></label>
											<input type="text" autocomplete="off" id="c24" class="form-control default-date-picker" style="width:200px;font-weight:normal;" placeholder="请选择日期">							
									</div>
									<div id="installment_date2" class="form-group" style="width:100%;margin-top:10px;display:none;">								
											<label class="control-label" style="width:150px;">Installment 2<br/>Due Date<span style="color:red;">*</span></label>
											<input type="text" autocomplete="off" id="c24a" class="form-control default-date-picker" style="width:200px;font-weight:normal;" placeholder="请选择日期">							
									</div>
									<div id="installment_date3" class="form-group" style="width:100%;margin-top:10px;display:none;">								
											<label class="control-label" style="width:150px;">Installment 3<br/>Due Date<span style="color:red;">*</span></label>
											<input type="text" autocomplete="off" id="c24b" class="form-control default-date-picker" style="width:200px;font-weight:normal;" placeholder="请选择日期">							
									</div>																		
									<div class="form-group" style="width:100%;margin-top:10px;">								
											<label class="control-label" style="width:150px;">学费总金额<br/>Tuition Fee<span style="color:red;">*</span></label>
											<input type="text" autocomplete="off" id="c25" class="form-control" style="width:200px;font-weight:normal;" placeholder="">							
									</div>
									<div class="form-group" style="width:100%;margin-top:10px;">								
											<label class="control-label" style="width:150px;">每学期学费金额<br/>Per Term Tuition Fee<span style="color:red;">*</span></label>
											<input type="text" autocomplete="off" id="c26" class="form-control" style="width:200px;font-weight:normal;" placeholder="">							
									</div>
									<div class="form-group" style="width:100%;margin-top:10px;">								
											<label class="control-label" style="width:150px;">本次收款日期<span style="color:red;">*</span></label>
											<input type="text" autocomplete="off" id="c27" class="form-control default-date-picker" style="width:200px;font-weight:normal;" placeholder="请选择日期" data-date-format="yyyy-mm-dd">
											<label class="control-label">收款方式<span style="color:red;">*</span></label>
											<select class="form-control" style="width:150px;font-weight:normal;" id="c28"></select>									
									</div>
									<div class="form-group" style="display:block;margin-top:10px;">
											<div class="form-group">
												<label class="control-label" style="width:150px;">本次应收学费<span style="color:red;">*</span></label>
												$<input type="text" autocomplete="off" id="c29" class="form-control" onkeyup="computeDiscount(this.value)" style="width:100px;font-weight:normal;">
											</div>
											<div class="form-group" style="margin-left:10px;">
												<label class="control-label">折扣</label>
												$<input type="text" autocomplete="off" disabled="disabled" id="c30" value="0" class="form-control" style="width:100px;font-weight:normal;">
											</div>
											<div class="form-group" style="margin-left:10px;">
												<label class="control-label">本次收款</label>
												$<input type="text" autocomplete="off" id="c31" class="form-control" onkeyup="computeDiscount(this.value)" style="width:100px;font-weight:normal;">
											</div>
											<div class="form-group" style="margin-top:10px;margin-left:150px;">
												<label class="control-label">预收业绩</label>
												$<input type="text" autocomplete="off" disabled="disabled" id="c32" class="form-control" style="width:100px;font-weight:normal;">&nbsp;(“预收业绩”仅供参考，具体以会计结算为准。)
											</div>									
									</div>
									<div class="form-group" style="width:100%;margin-top:10px;">
											<label class="control-label">备注</label>
											<textarea id="c33" class="form-control" style="width:98%;font-weight:normal;"></textarea>
									</div>
							</div>
							<div>
									<div style="text-align: center;">流程进度条...待实现...</div>
							</div>
							<div v-if="ap_list==='WA'">
									<hr/>
									<div class="form-group" style="width:100%;line-height:40px;">
										<label class="control-label"><strong>状态：</strong></label>
										<select class="form-control" id="c200" onchange="changeOvstState(this.value);">											
										<option v-if="flowstate_wa!=='PAID'" value="">请选择</option>
										<option v-if="flowstate_gw==='REVIEW'" value="REVIEW">资料审核中</option>
										<option v-if="flowstate_wa==='REVIEW'" value="FINISH">资料已审核</option>
										<option v-if="flowstate_wa==='FINISH'" value="APPLY">已提交申请</option>
										<option v-if="flowstate_wa==='APPLY'" value="COMPLETE">申请成功等待COE支付</option>
										<option v-if="flowstate_wa==='COMPLETE' || flowstate_wa==='PAID'" value="PAID">COE支付成功</option>
										<option v-if="flowstate_wa!='PAID' && flowstate_wa==='COMPLETE'" value="CLOSE">关闭申请</option>
										</select>
									</div>
									<div id="close_remarks" class="form-group" style="display:none;width:100%;line-height:40px;">
										<label class="control-label"><strong>备注：</strong></label>
										<textarea id="c101" class="form-control" style="width:98%"></textarea>							
									</div>
							</div>
							</form>
					</div>
					<div class="modal-footer" style="text-align: center;">
							<dle v-if="ap_list==='GW'">									
									<dle v-if="flowstate_gw==='REVIEW'">
									<button onclick="flowstep('PENDING',1)" type="button" class="btn btn-default">撤回</button>
									</dle>
									<dle v-if="flowstate_wa==='PAID' && !submitted">
									<input type="file" id="f1c" style="display:none">
									<input type="hidden" id="flist1" value="" />
									<div id="show_pic" style="display:none;padding-bottom:10px;"></div>
									<button onclick="upload_receipt_pic('f1c')" id="upload_certificate" type="button" class="btn btn-danger" style="display:;">上传COE凭证</button>
									<button onclick="reqCommissionOvst()" type="button" class="btn btn-primary">申请月奖</button>
									</dle>
									<button v-if="submitted" onclick="window.location.href='mycommission.html'" type="button" class="btn btn-primary">月奖已申请，请至佣金表查看</button>
							</dle>
							<dle v-if="ap_list==='WA'">
									<input type="file" id="f1b" style="display:none">
									<input type="hidden" id="flist" value="" />
									<div id="show_pic" style="display:none;padding-bottom:10px;"></div>
									<button onclick="upload_receipt_pic('f1b')" id="upload_certificate" type="button" class="btn btn-danger" style="display:none;">上传收款凭证</button>
									<button v-if="flowstate_wa!='PAID'" onclick="checkform('OVST');" type="button" class="btn btn-primary">提交</button>							
									<dle v-if="flowstate_gw==='REVIEW'">
											<button v-if="flowstate_wa===null" onclick="flowstep('PENDING',0)" id="btnRefuse" type="button" class="btn btn-default">驳回</button>
									</dle>									
							</dle>							
							<button onclick="" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
					</div>
				</div>
			</div>
</div>

</div>
<script>
var v_sub = new Vue({
				el: '#app_sub',
				data: {
					admin: sessionStorage.getItem("admin"),
					ap_list: sessionStorage.getItem("ap_list"),
					m_list: localStorage.getItem("str_html"),
					adviser_id: sessionStorage.getItem("adviser_id"),
					official_id: sessionStorage.getItem("official_id"),
					mara_id: sessionStorage.getItem("mara_id"),
					flowstate_gw: '',
					flowstate_wa: '',
					flowstate_ma: '',
					submitted: 0,					
					order_detail: [],
					subagency_id: 0
				},
				created: function() {					
				}
});

function show_addnewservice_id(orderId,type)
{
		v.orderId = orderId;
		//服务详细页
		$.ajax({
      url: 'serviceOrder/get?id='+orderId,
      type: 'GET',
      dataType: 'json'
    }).done(function(response) {			        	
    	response = response.data;
    	v.orderType = type;
    	v_sub.order_detail = response;//存储数据到本地
    	if (type == 'VISA')
    	{    			
    			$('#show_addnewservice1_id').modal('show');
    			//签证	
        	$('#show_addnewservice1_id #b1').html(response.user.name);
        	$('#show_addnewservice1_id #b2').html(response.adviser.name);
        	$('#show_addnewservice1_id #b3').html(response.mara.name);
        	$('#show_addnewservice1_id #b4').html(response.official.name);
        	$('#show_addnewservice1_id #b6').html(response.service.code);
        	var str_ispay = '否';
        	$('#show_addnewservice1_id #show_paid').hide();
        	if (response.pay)
        	{
        			str_ispay = '是';
        			$('#show_addnewservice1_id #show_paid').show();			        	
        	}
        	$('#show_addnewservice1_id #b7').html(str_ispay);
        	$('#show_addnewservice1_id #b8').html(v.getTime(response.receiveDate));        	
        	if (response.receiveTypeId) $('#show_addnewservice1_id #b9').html(response.receiveType.name);
        	$('#show_addnewservice1_id #b10').html(response.receivable);
        	$('#show_addnewservice1_id #b11').html(response.discount);
        	$('#show_addnewservice1_id #b12').html(response.received);
        	$('#show_addnewservice1_id #b13').html(response.paymentTimes);
        	$('#show_addnewservice1_id #b14').html(response.amount);
        	//$('#show_addnewservice1_id #b14a').html(response.perAmount);
        	$('#show_addnewservice1_id #b15').html(response.gst);
        	$('#show_addnewservice1_id #b16').html(response.deductGst);
        	$('#show_addnewservice1_id #b17').html(response.expectAmount);
        	if (response.remarks) response.remarks = url_replace(response.remarks);
        	$('#show_addnewservice1_id #b18').html(response.remarks);
        	//签证凭证
        	if (response.visaVoucherImageUrl)
        	{
        			$('#show_addnewservice1_id #visapic_url').html('<a href="/statics'+response.visaVoucherImageUrl+'" target="_blank">查看</a>');
        			$('#show_addnewservice1_id #show_visapic').show();
        	}else
        	{
        			$('#show_addnewservice1_id #visapic_url').html('');
        			$('#show_addnewservice1_id #show_visapic').hide();
        	}
        	
        	v_sub.flowstate_gw = response.review.adviserState;
        	v_sub.flowstate_wa = response.review.officialState;
        	v_sub.flowstate_ma = response.review.maraState;
        	if (response.review.officialState == 'REVIEW')
					{
							if (response.review.maraState == 'FINISH')
							{
									str_state = 'FINISH';//Mara已审核
									$("#b19").val('FINISH');
							}else
							{
									str_state = 'WA_REVIEW';//文案审核中...
							}
					}else if (response.review.officialState != null)
					{
							str_state = response.review.officialState;
					}
        	if (response.review.maraState == 'WAIT' || response.review.officialState == 'WAIT')
					{
							switch(v_sub.ap_list)
							{												
									case 'GW':
											str_state = 'WA_REVIEW';//文案审核中..
									break;
									case 'WA':
											str_state = 'WA_MA_WAIT';//已提交Mara审核											
									break;
									case 'MA':
											str_state = 'MA_WAIT';//待审核
									break;
							}										
					}
					if (str_state == 'WA_REVIEW') $("#b19").val('REVIEW');
					if (str_state == 'WA_MA_WAIT' ||  str_state == 'MA_WAIT') $("#b19").val('WAIT');
					if (str_state == 'APPLY' || str_state == 'COMPLETE' || str_state == 'CLOSE') $("#b19").val(str_state);
    	}else
    	{
    			//留学
    			$('#show_addnewservice2_id #upload_certificate').hide();
    			$('#show_addnewservice2_id #c1').html(response.user.name);
        	$('#show_addnewservice2_id #c8').html(response.adviser.name);
        	$('#show_addnewservice2_id #c9').html(response.official.name);
        	$('#show_addnewservice2_id #c3').html(response.school.name);
        	$('#show_addnewservice2_id #c4').html(response.school.subject);
        	v_sub.submitted = response.submitted;
        	var str_issettle = '否';
        	if (response.settle) str_issettle = '是';
        	$('#show_addnewservice2_id #c5').html(str_issettle);
        	var str_isdeposituser = '否';
        	if (response.depositUser)
        	{
        			str_isdeposituser = '是';
        			$('#show_addnewservice2_id #show_deposit_user').show();	
        	}
        	$('#show_addnewservice2_id #c6').html(str_isdeposituser);
        	$('#show_addnewservice2_id #c7').html(response.subagency.name);
        	v_sub.subagency_id = response.subagencyId;
        	var str_ispay = '否';
        	if (response.pay) str_ispay = '是';
        	$('#show_addnewservice2_id #c10').html(str_ispay);
        	$('#show_addnewservice2_id #c11').html(v.getTime(response.receiveDate));
        	if (response.depositUser) $('#show_addnewservice2_id #c12').html(response.receiveType.name);
        	$('#show_addnewservice2_id #c13').html(response.receivable);
        	$('#show_addnewservice2_id #c14').html(response.discount);
        	$('#show_addnewservice2_id #c15').html(response.received);
        	if (response.remarks) response.remarks = url_replace(response.remarks);        	
        	$('#show_addnewservice2_id #c16').html(response.remarks);
        	$('#show_addnewservice2_id #c16a').val(response.remarks);
        	//CEO付款凭证
        	if (response.paymentVoucherImageUrl3)
        	{
        			$('#show_addnewservice2_id #paymentpic_url').html('<a href="/statics'+response.paymentVoucherImageUrl3+'" target="_blank">查看</a>');
        			$('#show_addnewservice2_id #show_paymentpic').show();
        	}else
        	{
        			$('#show_addnewservice2_id #paymentpic_url').html('');
        			$('#show_addnewservice2_id #show_paymentpic').hide();
        	}
        	
        	v_sub.flowstate_gw = response.review.adviserState;
        	v_sub.flowstate_wa = response.review.officialState;
        	if (v_sub.ap_list === 'WA' && v_sub.flowstate_wa!='PAID')
        	{
        			$('#show_addnewservice2_id #c16').hide();
        			$('#show_addnewservice2_id #c16a').show();
        	}else
        	{
        			$('#show_addnewservice2_id #c16').show();
        			$('#show_addnewservice2_id #c16a').hide();
        	}
        	if (v_sub.ap_list === 'WA' && v_sub.flowstate_wa!='APPLY' && v_sub.flowstate_wa!='PAID' && v_sub.flowstate_wa!='COMPLETE') 
        	{
        			$('#show_addnewservice2_id #c7a').val(v_sub.subagency_id);
        			$('#show_addnewservice2_id #c7').hide();
        			$('#show_addnewservice2_id #c7a').show();
        	}else
        	{
        			$('#show_addnewservice2_id #c7').show();
        			$('#show_addnewservice2_id #c7a').hide();
        	}
        	//文案操作状态
        	var str_state = '';
        	if (v_sub.flowstate_gw == 'REVIEW') $("#c200").val('PENDING');
        	if (v_sub.flowstate_wa == 'REVIEW') $("#c200").val('REVIEW');
        	if (v_sub.flowstate_wa == 'FINISH' || v_sub.flowstate_wa == 'APPLY' || v_sub.flowstate_wa == 'COMPLETE' || v_sub.flowstate_wa == 'PAID' || v_sub.flowstate_wa == 'CLOSE') $("#c200").val(v_sub.flowstate_wa);
        	v.addnewservice2_bind = 1;
					$('#show_addnewservice2_id').modal('show');
    	}
    });      				      		
}

function checkform(type)
{
		if (type == 'VISA')
		{
				if ($('#show_addnewservice1_id #b19').val() == '')
				{
						$('#alert_error').css('marginLeft','30%');		
						$('#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
			      $("#error_info").html('请选择需要修改的状态！');
						return false;
				}else
				{						
						flowstep($('#show_addnewservice1_id #b19').val(),1);
				}
		}else
		{
				if ($('#show_addnewservice2_id #c200').val() == '')
				{
						$('#alert_error').css('marginLeft','30%');		
						$('#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
			      $("#error_info").html('请选择需要修改的状态！');
						return false;
				}else
				{
						flowstep($('#show_addnewservice2_id #c200').val(),1);
				}
		}
}

function changeVisaState(va)
{
		$('#show_addnewservice1_id #upload_certificate').hide();
		$('#show_addnewservice1_id #close_remarks').hide();
		$('#show_addnewservice1_id #btnRefuse').hide();
		$('#show_addnewservice1_id #btnCancel').hide();		
		switch(va)
		{				
				case 'APPLY':
					//$('#show_addnewservice1_id #upload_certificate').show();
				break;
				case 'COMPLETE':
					$('#show_addnewservice1_id #upload_certificate').show();
				break;
				case 'CLOSE':
					$('#show_addnewservice1_id #close_remarks').show();
				break;
				case '':
					$('#show_addnewservice1_id #btnRefuse').show();
				break;			
		}
}

function changeOvstState(va,state)
{
		$('#show_addnewservice2_id #upload_certificate').hide();
		$('#show_addnewservice2_id #close_remarks').hide();
		$('#show_addnewservice2_id #btnRefuse').hide();
		switch(va)
		{				
				case 'APPLY':					
				break;
				case 'COMPLETE':
				break;
				case 'PAID':
					$('#show_addnewservice2_id #upload_certificate').show();
				break;
				case 'CLOSE':
					$('#show_addnewservice2_id #close_remarks').show();
				break;
				case '':
					$('#show_addnewservice2_id #btnRefuse').show();
				break;				
		}
}

v.$watch('addnewservice2_bind', function(obj) {
		$('.default-date-picker').datepicker({   				
	        format: 'dd/mm/yyyy'
	  });
	  $('.default-date-picker1').datepicker({   				
	        format: 'dd/mm/yyyy'			        
	  });
	  //绑定收款方式
    var receive_type = $("#show_addnewservice2_id #c28");
    receive_type.append("<option value='0'>请选择</option>");
    $.ajax({
      url: 'receiveType/list?state=ENABLED',
      type: 'GET',
      async: false,
      dataType: 'json'
    }).done(function(response) {
    	response = response.data;    
    	for (var item in response)
    	{
    			receive_type.append("<option value='"+response[item].id+"'>"+response[item].name+"</option>");
    	}        	 	    
    });
    //绑定Subagency列表
    var obj_subagencyId = $("#show_addnewservice2_id #c7a");	
    $.ajax({
      url: 'subagency/list',
      type: 'GET',
      async: false,
      dataType: 'json'
    }).done(function(response) {
    	response = response.data;
    	for (var item in response)
    	{
    			obj_subagencyId.append("<option value='"+response[item].id+"'>"+response[item].name+"</option>");
    	}
    	obj_subagencyId.val(v_sub.subagency_id);   
    });  
});

function setInstallment(va)
{
		switch(parseInt(va))
		{
				case 1:
						$("#show_addnewservice2_id #installment_date2").hide();
						$("#show_addnewservice2_id #installment_date3").hide();
				break;
				case 2:
						$("#show_addnewservice2_id #installment_date2").show();
						$("#show_addnewservice2_id #installment_date3").hide();
				break;
				case 3:
						$("#show_addnewservice2_id #installment_date2").show();
						$("#show_addnewservice2_id #installment_date3").show();
				break;
		}
}

function reqCommissionOvst()
{
		var jqInputs = $('input',$("#show_addnewservice2_id"));
    var jqSelect = $('select',$("#show_addnewservice2_id"));
    var jqTextarea = $('textarea',$("#show_addnewservice2_id"));        
    
    var check_result = false;
    if (jqInputs[0].value != '' && jqInputs[3].value != '' && jqInputs[6].value != '' && jqInputs[7].value != '' && jqInputs[8].value != '' && jqInputs[9].value != '' && jqInputs[10].value != '' && jqInputs[11].value != '' && jqSelect[2].value != '0')
    {
    		if (parseInt(jqSelect[1].value) > 1)
    		{
		    		switch(parseInt(jqSelect[1].value))
		    		{
		    				case 2:
		    					if (jqInputs[4].value != '') check_result = true;
		    				break;
		    				case 3:
		    					if (jqInputs[4].value != '' && jqInputs[5].value != '') check_result = true;
		    				break;
		    		}
    		}else
    		{   		
    				check_result = true;
    		}
    }
    if (!check_result)
    {
    		$('#show_addnewservice2_id #alert_error').css('marginTop','50%');
    		$('#show_addnewservice2_id #alert_error').css('marginLeft','30%');
    		$('#show_addnewservice2_id #alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
        $("#show_addnewservice2_id #error_info").html('提示：所有红色字段必须填写或选择！');
    		return false;
    }else
    {         	            	            	                             
       	var str_url = "commissionOrder/add";    		  		
       	var json = {};
       	       	
       	json['serviceOrderId'] = v.orderId;
       	json['isSettle'] = v_sub.order_detail.settle;
       	json['isDepositUser'] = v_sub.order_detail.depositUser;
       	json['schoolId'] = v_sub.order_detail.schoolId;
       	json['studentCode'] = jqInputs[0].value;
       	json['userId'] = v_sub.order_detail.userId;
       	json['adviserId'] = v_sub.order_detail.adviserId;
       	json['officialId'] = v_sub.order_detail.officialId;
       	json['isStudying'] = true;
       	json['installment'] = jqSelect[1].value;
       	var d = 0;        		
    		if (jqInputs[1].value != '')
    		{
        		var arr_d = jqInputs[1].value.split("/");
        		var str_d = arr_d[2]+'-'+arr_d[1]+'-'+arr_d[0];
            var date = new Date(str_d);
            d = date.getTime();
      	}
       	json['startDate'] = d;
       	if (jqInputs[2].value != '')
    		{
        		var arr_d = jqInputs[2].value.split("/");
        		var str_d = arr_d[2]+'-'+arr_d[1]+'-'+arr_d[0];
            var date = new Date(str_d);
            d = date.getTime();
      	}else
      	{
      			d = 0;
      	}
       	json['endDate'] = d;
       	if (jqInputs[3].value != '')
    		{
        		var arr_d = jqInputs[3].value.split("/");
        		var str_d = arr_d[2]+'-'+arr_d[1]+'-'+arr_d[0];
            var date = new Date(str_d);
            d = date.getTime();
      	}else
      	{
      			d = 0;
      	}
       	json['installmentDueDate1'] = d;//installment Date1
       	if (jqInputs[4].value != '')
    		{
        		var arr_d = jqInputs[4].value.split("/");
        		var str_d = arr_d[2]+'-'+arr_d[1]+'-'+arr_d[0];
            var date = new Date(str_d);
            d = date.getTime();
      	}else
      	{
      			d = 0;
      	}
       	json['installmentDueDate2'] = d;//installment Date2
       	if (jqInputs[5].value != '')
    		{
        		var arr_d = jqInputs[5].value.split("/");
        		var str_d = arr_d[2]+'-'+arr_d[1]+'-'+arr_d[0];
            var date = new Date(str_d);
            d = date.getTime();
      	}else
      	{
      			d = 0;
      	}
       	json['installmentDueDate3'] = d;//installment Date3
       	json['tuitionFee'] = jqInputs[6].value;
       	json['perTermTuitionFee'] = jqInputs[7].value;
       	if (jqInputs[8].value != '')
    		{
        		var arr_d = jqInputs[8].value.split("/");
        		var str_d = arr_d[2]+'-'+arr_d[1]+'-'+arr_d[0];
            var date = new Date(str_d);
            d = date.getTime();
      	}else
      	{
      			d = 0;
      	}
       	json['receiveDate'] = d;
       	json['receiveTypeId'] = jqSelect[2].value;
       	json['perAmount'] = jqInputs[9].value;//本次应收学费
       	json['discount'] = jqInputs[10].value;
       	json['amount'] = jqInputs[11].value;
       	//json['expectAmount'] = jqInputs[12].value;
       	json['remarks'] = jqTextarea[1].value;
       	//console.log(json);
       	//return false;
       	//校验是否上传了凭证
       	var flist = $("#show_addnewservice2_id #flist1").val();
       	if (flist != '')
   			{
   					//对凭证进行处理
   					var arr = flist.split(',');
   					if (arr.length)
   					{
   							json['paymentVoucherImageUrl1'] = arr[0];
   							if (arr.length == 2) json['paymentVoucherImageUrl2'] = arr[1];
   					}
   			}else
   			{
   					$('#show_addnewservice2_id #alert_error').css('marginTop','50%');
      			$('#show_addnewservice2_id #alert_error').css('marginLeft','30%');
   					$('#show_addnewservice2_id #alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
      			$("#show_addnewservice2_id #error_info").html('收款凭证没有上传，请上传之后再提交。');
    				return false;
   			}
       	
       	$.post(str_url, json,
		   	function(data){
		   			if (parseInt(data.code) == 0)
		   			{
		   					$('#show_addnewservice2_id #alert_success').css('marginTop','50%');
		   					$('#show_addnewservice2_id #alert_success').css('marginLeft','30%');
		   					$('#show_addnewservice2_id #alert_success').addClass('alert-success').show().delay(1500).fadeOut();
		   					setTimeout(function(){window.location.href = "mycommission-ovst.html";}, 2000);
		   			}else
		   			{
		   					$('#show_addnewservice2_id #alert_error').css('marginTop','70%');
		   					$('#show_addnewservice2_id #alert_error').css('marginLeft','30%');
		   					$('#show_addnewservice2_id #alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
          			$("#show_addnewservice2_id #error_info").html(data.message);
	        			return false;
		   			}
		   	});
    }
}

function computeDiscount(v)
{
		var perAmount = $("#show_addnewservice2_id #c29").val();
		var amount = $("#show_addnewservice2_id #c31").val();
		if (parseInt(perAmount) && parseInt(amount))
		{				
				var discount = parseInt(perAmount) - parseInt(amount);
				$("#show_addnewservice2_id #c30").val(discount);
		}
		//计算预收佣金
		if (parseInt(amount))
		{
				var expect_amount = (parseInt(amount)*1.1).toFixed(2);
				$("#show_addnewservice2_id #c32").val(expect_amount);
		}
}

$('#show_addnewservice1_id #f1a').live('change', function (e) {
		var formData = new FormData();					
		formData.append("file",$("#f1a")[0].files[0]);
		
		$.ajax({
        url:'serviceOrder/upload_visa_voucher_img',
        dataType:'json',
        type:'POST',
        async: false,
        data: formData,
        processData : false, //使数据不做处理
        contentType : false,
        success: function(data){			        		
            if (data.code == '0') {
            		/*var flist = $("#show_addnewservice1_id #flist").val();
            		if (flist)
            		{
            				$("#show_addnewservice1_id #flist").val(flist+','+data.data);
            		}else
            		{
            				$("#show_addnewservice1_id #flist").val(data.data);
            		}*/
            		var pic_url = data.data;
            		$("#show_addnewservice1_id #flist").val(pic_url);            		
		        		$("#show_addnewservice1_id #show_pic").append('<a href="/statics'+pic_url+'" target="_blank">查看签证凭证</a>&nbsp;');
		        		$("#show_addnewservice1_id #show_pic").show();            		
            		//更新签证凭证
            		var json = {};
            		json['visaVoucherImageUrl'] = pic_url;
            		var str_url = 'serviceOrder/updateVoucherImageUrl?id='+v.orderId;
            		$.post(str_url, json,
		   					function(data1){
		   							if (data1.code = '0')
		   							{
				   							$('#show_addnewservice1_id #alert_success').css('marginTop','50%');
						   					$('#show_addnewservice1_id #alert_success').css('marginLeft','30%');						   					
						   					$("#show_addnewservice1_id #success_info").html('签证凭证更新成功！');
						   					$('#show_addnewservice1_id #alert_success').addClass('alert-success').show().delay(1500).fadeOut();
				   					}else
				   					{
				   							$('#show_addnewservice1_id #alert_error').css('marginTop','60%');
					          			$('#show_addnewservice1_id #alert_error').css('marginLeft','60%');
							   					$('#show_addnewservice1_id #alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
					          			$("#show_addnewservice1_id #error_info").html(data1.message);
				   					}
		   					});          		
            }else
            {
            		$('#show_addnewservice1_id #alert_error').css('marginTop','60%');
          			$('#show_addnewservice1_id #alert_error').css('marginLeft','60%');
		   					$('#show_addnewservice1_id #alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
          			$("#show_addnewservice1_id #error_info").html('签证凭证上传失败！');
            }	
        },
        error:function(response){
            console.log(response);
        }
    });
});

$('#show_addnewservice2_id #f1b').live('change', function (e) {
		var formData = new FormData();					
		formData.append("file",$("#f1b")[0].files[0]);
		
		$.ajax({
        url:'serviceOrder/upload_img',
        dataType:'json',
        type:'POST',
        async: false,
        data: formData,
        processData : false, //使数据不做处理
        contentType : false,
        success: function(data){			        		
            if (data.code == '0') {
            		/*var flist = $("#show_addnewservice2_id #flist").val();
            		if (flist)
            		{
            				$("#show_addnewservice2_id #flist").val(flist+','+data.data);
            		}else
            		{
            				$("#show_addnewservice2_id #flist").val(data.data);
            		}*/
            		var pic_url = data.data;
            		$("#show_addnewservice2_id #flist").val(pic_url); 
		        		$("#show_addnewservice2_id #show_pic").append('<a href="/statics'+data.data+'" target="_blank">查看凭证</a>&nbsp;');
		        		$("#show_addnewservice2_id #show_pic").show();
		        		//文案更新收款凭证
            		var json = {};
            		json['paymentVoucherImageUrl'] = pic_url;
            		var str_url = 'serviceOrder/updateVoucherImageUrl?id='+v.orderId;
            		$.post(str_url, json,
		   					function(data1){
		   							if (data1.code = '0')
		   							{
				   							$('#show_addnewservice2_id #alert_success').css('marginTop','50%');
						   					$('#show_addnewservice2_id #alert_success').css('marginLeft','30%');						   					
						   					$("#show_addnewservice2_id #success_info").html('COE收款凭证更新成功！');
						   					$('#show_addnewservice2_id #alert_success').addClass('alert-success').show().delay(1500).fadeOut();
				   					}else
				   					{
				   							$('#show_addnewservice2_id #alert_error').css('marginTop','60%');
				          			$('#show_addnewservice2_id #alert_error').css('marginLeft','60%');
						   					$('#show_addnewservice2_id #alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
				          			$("#show_addnewservice2_id #error_info").html(data1.message);
				   					}
		   					});
            }else
            {
            		$('#show_addnewservice2_id #alert_error').css('marginTop','60%');
          			$('#show_addnewservice2_id #alert_error').css('marginLeft','60%');
		   					$('#show_addnewservice2_id #alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
          			$("#show_addnewservice2_id #error_info").html('收款凭证上传失败！');
            }	
        },
        error:function(response){
            console.log(response);
        }
    });
});

$('#show_addnewservice2_id #f1c').live('change', function (e) {
		var formData = new FormData();					
		formData.append("file",$("#f1c")[0].files[0]);
		
		$.ajax({
        url:'serviceOrder/upload_img',
        dataType:'json',
        type:'POST',
        async: false,
        data: formData,
        processData : false, //使数据不做处理
        contentType : false,
        success: function(data){			        		
            if (data.code == '0') {
            		var flist = $("#show_addnewservice2_id #flist1").val();
            		if (flist)
            		{
            				$("#show_addnewservice2_id #flist1").val(flist+','+data.data);
            		}else
            		{
            				$("#show_addnewservice2_id #flist1").val(data.data);
            		}
		        		$("#show_addnewservice2_id #show_pic").append('<a href="/statics'+data.data+'" target="_blank">查看凭证</a>&nbsp;');
		        		$("#show_addnewservice2_id #show_pic").show();
            }else
            {
            		$('#show_addnewservice2_id #alert_error').css('marginTop','60%');
          			$('#show_addnewservice2_id #alert_error').css('marginLeft','60%');
		   					$('#show_addnewservice2_id #alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
          			$("#show_addnewservice2_id #error_info").html('收款凭证上传失败！');
            }	
        },
        error:function(response){
            console.log(response);
        }
    });
});
</script>